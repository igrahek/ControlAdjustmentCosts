---
title: "DDM results Experiment 4"
output:
  html_document:
    code_folding: hide
    toc: true
    toc_float: true

---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```



# Loading libraries

```{r, message=FALSE}
library(dplyr)
library(ggplot2)
library(purrr)
library(tidyr)
library(gridExtra)
library(cowplot)
library(sjPlot)
library(RColorBrewer)
library(knitr)
library(data.table)
library(brms)
library(viridis)


# Functions
test.params <- function(df) {
  inner_join(inner_join(inner_join(df %>%
                                     map_dfr(mean) %>%
                                     gather(parameter, estimate, everything()) %>% dplyr::rename(Mean=estimate),
                                   df %>%
                                     map_dfr(sd) %>%
                                     gather(parameter, estimate, everything()) %>% dplyr::rename(SD=estimate),by='parameter'),
                        
                        df %>% map(~ .x > 0) %>% 
                          map_dfr(mean) %>%
                          gather(parameter, pvalue, everything()) %>%
                          mutate(pvalue = if_else(round(pvalue)==1, 1-pvalue, pvalue),
                                 sig = if_else(pvalue < 0.001, "***",
                                               if_else(pvalue < 0.01, "**",
                                                       if_else(pvalue < 0.05, "*", "n.s."))))),
             inner_join(df %>%
                          map_dfr(function(x) return(quantile(x,0.975)[[1]])) %>%
                          gather(parameter, estimate, everything()) %>% dplyr::rename(CI_upper=estimate),
                        df %>% map_dfr(function(x) return(quantile(x,0.025)[[1]])) %>%
                          gather(parameter, estimate, everything()) %>% dplyr::rename(CI_lower=estimate),by='parameter'),by='parameter') 
}

# Define the summary posterior function
summarize_posterior <- function(V1,V2,effect) {
   post = as.data.frame(V1-V2)
   ggplot(data=post,aes(x=`V1 - V2`)) + 
     geom_histogram(bins=50) + 
     geom_vline(xintercept=0, linetype="dotted",size=1) + 
     labs(title=paste(effect,"p<0 = ",length(post[post<0])/length(post$`V1 - V2`))) +
     theme_classic() 

}

multiplot <- function(..., plotlist=NULL, file, cols=1, layout=NULL) {
  library(grid)
  
  # Make a list from the ... arguments and plotlist
  plots <- c(list(...), plotlist)
  
  numPlots = length(plots)
  
  # If layout is NULL, then use 'cols' to determine layout
  if (is.null(layout)) {
    # Make the panel
    # ncol: Number of columns of plots
    # nrow: Number of rows needed, calculated from # of cols
    layout <- matrix(seq(1, cols * ceiling(numPlots/cols)),
                     ncol = cols, nrow = ceiling(numPlots/cols))
  }
  
  if (numPlots==1) {
    print(plots[[1]])
    
  } else {
    # Set up the page
    grid.newpage()
    pushViewport(viewport(layout = grid.layout(nrow(layout), ncol(layout))))
    
    # Make each plot, in the correct location
    for (i in 1:numPlots) {
      # Get the i,j matrix positions of the regions that contain this subplot
      matchidx <- as.data.frame(which(layout == i, arr.ind = TRUE))
      
      print(plots[[i]], vp = viewport(layout.pos.row = matchidx$row,
                                      layout.pos.col = matchidx$col))
    }
  }
}

# Base template
gg <- list(
  theme_bw(),
  theme(plot.title = element_text(hjust = 0.5, size=13),
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        panel.spacing = unit(0.75, "lines"),
        legend.box.spacing = unit(0.5, "lines"),
        legend.position = "bottom",
        legend.margin = margin(c(0, 0, 0, 0), unit='lines'))
)

# Density template
ggdensity <- list(
  gg,
  theme(panel.spacing = unit(0.25, "lines"),
        legend.key.size = unit(0.7, "lines"),
        legend.direction = "horizontal",
        axis.ticks.y = element_blank(),
        axis.text.y = element_blank(),
        legend.box.spacing = unit(0.25, "lines"))
)
```




# Main analyses - Interval type on NDT


## Rhats

```{r, message=FALSE}
# Import the Rhats
rhats <- fread('output/Mixed/ae_only/modelMixed1/modelMixed1_RHat.csv', header = T)
colnames(rhats) = c("parameter","Rhat")


# Plot the Rhats

# Set parameters for plots
set_theme(base =theme_bw(base_size = 15, base_family = "")) # font size and theme
myColors = brewer.pal(3,"Set2") #colors
barfill <- "#4271AE"
barlines <- "#1F3552"

p =ggplot(rhats, aes(Rhat)) +
  geom_histogram(colour = barlines, fill = barfill,binwidth = 0.01)+ #colour = barlines, fill = barfill
  theme_bw() +
  labs(x = "Rhat", y = "Count\n")+
  theme(axis.line = element_line(size=1, colour = "black"),
        panel.grid.major = element_line(colour = "grey",size = 0.1,linetype = "dashed"),
        panel.grid.minor = element_line(colour = "grey",size = 0.1,linetype = "dashed"),
        panel.border = element_blank(),
        panel.background = element_blank(),
        plot.title = element_text(size = 18,  face = "bold",hjust = 0.5),
        text=element_text(colour="black", size = 14),
        axis.text.x=element_text(colour="black", size = 14),
        axis.text.y=element_text(colour="black", size = 14, face = "plain",hjust=0),
        axis.title=element_text(size=18,colour = "black",vjust = 1))

p


# Print the names of the low Rhat parameters
highRhats = subset(rhats,rhats$Rhat>1.1)
highRhats
```



## Trace plots


```{r, message=FALSE}
traces <- read.csv('output/Mixed/ae_only/modelMixed1/modelMixed1_traces.csv')

traces<-traces %>% dplyr::select(a_Intercept,
                                 a_C.intervalType..Sum..S.Speed.,
                                 a_C.blockType..Poly..Linear,
                                 a_C.blockType..Poly..Quadratic,
                                 a_C.blockType..Poly..Cubic,
                                 a_C.intervalType..Sum..S.Speed..C.blockType..Poly..Linear,
                                 a_C.intervalType..Sum..S.Speed..C.blockType..Poly..Quadratic,
                                 a_C.intervalType..Sum..S.Speed..C.blockType..Poly..Cubic,
                                 
                                 v_Intercept,
                                 v_C.intervalType..Sum..S.Speed.,
                                 v_C.congruency..Sum..S.incongruent.,
                                 v_C.blockType..Poly..Linear,
                                 v_C.blockType..Poly..Quadratic,
                                 v_C.blockType..Poly..Cubic,
                                 v_C.intervalType..Sum..S.Speed..C.blockType..Poly..Linear,
                                 v_C.intervalType..Sum..S.Speed..C.blockType..Poly..Quadratic,
                                 v_C.intervalType..Sum..S.Speed..C.blockType..Poly..Cubic,

                                 t_Intercept,
                                 t_C.intervalType..Sum..S.Speed.)%>%
                          
  mutate(a_Intercept=0.5*a_Intercept,
         a_C.intervalType..Sum..S.Speed.=0.5*a_C.intervalType..Sum..S.Speed.,
         a_C.blockType..Poly..Linear=0.5*a_C.blockType..Poly..Linear,
         a_C.blockType..Poly..Quadratic=0.5*a_C.blockType..Poly..Quadratic,
         a_C.blockType..Poly..Cubic=0.5*a_C.blockType..Poly..Cubic,
         a_C.intervalType..Sum..S.Speed..C.blockType..Poly..Linear=0.5*a_C.intervalType..Sum..S.Speed..C.blockType..Poly..Linear,
         a_C.intervalType..Sum..S.Speed..C.blockType..Poly..Quadratic=0.5*a_C.intervalType..Sum..S.Speed..C.blockType..Poly..Quadratic,
         a_C.intervalType..Sum..S.Speed..C.blockType..Poly..Cubic=0.5*a_C.intervalType..Sum..S.Speed..C.blockType..Poly..Cubic)



# For each parameter
colNames= names(traces)

for (parameter in colNames) {

  #Plotting
  plot_data1 = traces[1:2000,]
  plot_data2 = traces[2001:4000,]
  plot_data3 = traces[4001:6000,]
  plot_data4 = traces[6001:8000,]
  plot_data5 = traces[8001:10000,]



  traces_plot = ggplot(NULL) +

    # Chain 1
    geom_line(data=plot_data1,mapping =aes_string(y=parameter,x = 1:2000), colour="red")+

    # Chain 2
    geom_line(data=plot_data2,mapping =aes_string(y=parameter,x = 1:2000), colour="royalblue1")+

    # Chain 3
    geom_line(data=plot_data3,mapping =aes_string(y=parameter,x = 1:2000), colour="springgreen")+

    # Chain 4
    geom_line(data=plot_data4,mapping =aes_string(y=parameter,x = 1:2000), colour="grey0")+

    # Chain 5
    geom_line(data=plot_data5,mapping =aes_string(y=parameter,x = 1:2000), colour="coral")+
    theme_classic(base_size = 18) +

    ggtitle(parameter)  + ylab("Parameter value") + xlab("Sample")



  print(traces_plot)
}
```




## PPCs


```{r, message=FALSE}

df.ppc <- fread('output/Mixed/ae_only/modelMixed1/modelMixed1_simData.csv') %>%
  mutate(simResponse=rt_sampled>0,
         Response=rt>0,
         rt_unsigned = abs(rt),
         rt_sampled_unsigned = abs(rt_sampled))

df.ppc.sim <- df.ppc %>% filter(sample==0,rt_sampled_unsigned<=3)

df.ppc.data <- df.ppc %>% filter(sample==0,rt_unsigned<=3)

ratio.true <- sum(!df.ppc.data$Response)/sum(df.ppc.data$Response)

ratio.simu <- sum(!df.ppc.sim$simResponse)/sum(df.ppc.sim$simResponse)

# Density plots with means
ggplot(df.ppc.data %>% filter(Response),
       aes(x=rt_unsigned,color='Correct',linetype='True')) +
  geom_density(size=1) +
  geom_density(data=df.ppc.data %>% filter(!Response),
               size=1,
               aes(x=rt_unsigned,y=-..density..*ratio.true,color='Incorrect',linetype='True'),
  ) +
  geom_density(data=df.ppc.sim %>% filter(simResponse),
               size=1,
               aes(x=rt_sampled_unsigned,color='Correct',linetype='Simulation')) +
  geom_density(data=df.ppc.sim %>% filter(!simResponse),
               size=1,
               aes(x=rt_sampled_unsigned,y=-..density..*ratio.simu,color='Incorrect',linetype='Simulation'),
  ) + geom_hline(yintercept=0) + ggdensity +
  xlab('Reaction Time') + coord_cartesian(xlim=c(0,2)) + facet_grid(cols=vars(intervalType,blockType)) + scale_linetype_manual(name='Data:',values=c('Simulation'=1,'True'=2)) + scale_color_manual(name='Response:',values=c('Correct'='blue','Incorrect'='red'))
```





## Import the posteriors


```{r, message=FALSE}
traces <- read.csv('output/Mixed/ae_only/modelMixed1/modelMixed1_traces.csv')


traces<-traces %>% dplyr::select(a_Intercept,
                                 a_C.intervalType..Sum..S.Speed.,
                                 a_C.blockType..Poly..Linear,
                                 a_C.blockType..Poly..Quadratic,
                                 a_C.blockType..Poly..Cubic,
                                 a_C.intervalType..Sum..S.Speed..C.blockType..Poly..Linear,
                                 a_C.intervalType..Sum..S.Speed..C.blockType..Poly..Quadratic,
                                 a_C.intervalType..Sum..S.Speed..C.blockType..Poly..Cubic,
                                 
                                 v_Intercept,
                                 v_C.intervalType..Sum..S.Speed.,
                                 v_C.congruency..Sum..S.incongruent.,
                                 v_C.blockType..Poly..Linear,
                                 v_C.blockType..Poly..Quadratic,
                                 v_C.blockType..Poly..Cubic,
                                 v_C.intervalType..Sum..S.Speed..C.blockType..Poly..Linear,
                                 v_C.intervalType..Sum..S.Speed..C.blockType..Poly..Quadratic,
                                 v_C.intervalType..Sum..S.Speed..C.blockType..Poly..Cubic,

                                 t_Intercept,
                                 t_C.intervalType..Sum..S.Speed.)%>%
                          
  mutate(a_Intercept=0.5*a_Intercept,
         a_C.intervalType..Sum..S.Speed.=0.5*a_C.intervalType..Sum..S.Speed.,
         a_C.blockType..Poly..Linear=0.5*a_C.blockType..Poly..Linear,
         a_C.blockType..Poly..Quadratic=0.5*a_C.blockType..Poly..Quadratic,
         a_C.blockType..Poly..Cubic=0.5*a_C.blockType..Poly..Cubic,
         a_C.intervalType..Sum..S.Speed..C.blockType..Poly..Linear=0.5*a_C.intervalType..Sum..S.Speed..C.blockType..Poly..Linear,
         a_C.intervalType..Sum..S.Speed..C.blockType..Poly..Quadratic=0.5*a_C.intervalType..Sum..S.Speed..C.blockType..Poly..Quadratic,
         a_C.intervalType..Sum..S.Speed..C.blockType..Poly..Cubic=0.5*a_C.intervalType..Sum..S.Speed..C.blockType..Poly..Cubic)

```

## Parameter estimates
```{r, message=FALSE}
summary_traces = traces

# Get the correct estimates (relative to sum & poly coding)
summary_traces$a_C.intervalType..Sum..S.Speed. = summary_traces$a_C.intervalType..Sum..S.Speed. * 2
summary_traces$v_C.intervalType..Sum..S.Speed. = summary_traces$v_C.intervalType..Sum..S.Speed. * 2

summary_traces$a_C.intervalType..Sum..S.Speed..C.blockType..Poly..Linear = (summary_traces$a_C.intervalType..Sum..S.Speed..C.blockType..Poly..Linear/0.6708204) * 2
summary_traces$v_C.intervalType..Sum..S.Speed..C.blockType..Poly..Linear = (summary_traces$v_C.intervalType..Sum..S.Speed..C.blockType..Poly..Linear/0.6708204) * 2

output <- test.params(summary_traces)
kable(output)
```


## Transform the traces
```{r, message=FALSE}
# Transform thresholds main effects
thresholdTransform = traces[,c("a_Intercept",
                               "a_C.blockType..Poly..Linear",
                               "a_C.blockType..Poly..Quadratic",
                               "a_C.blockType..Poly..Cubic")]

contrastMatrix = cbind(c(1,1,1,1),contr.poly(4))

tresholdByCondition = t(as.matrix(contrastMatrix) %*% t(as.matrix(thresholdTransform)))
colnames(tresholdByCondition) = c("a_Main_2intervals", "a_Main_4intervals", "a_Main_8intervals","a_Main_Fixed")
tresholdByCondition = as.data.frame(tresholdByCondition)



# Transform thresholds interactions
thresholdTransform = traces[,c("a_C.intervalType..Sum..S.Speed.",
                               "a_C.intervalType..Sum..S.Speed..C.blockType..Poly..Linear",
                               "a_C.intervalType..Sum..S.Speed..C.blockType..Poly..Quadratic",
                               "a_C.intervalType..Sum..S.Speed..C.blockType..Poly..Cubic")]

contrastMatrix = cbind(c(1,1,1,1),contr.poly(4))

tresholdByConditionInteraction = t(as.matrix(contrastMatrix) %*% t(as.matrix(thresholdTransform)))
colnames(tresholdByConditionInteraction) = c("a_Interaction_2intervals", "a_Interaction_4intervals", "a_Interaction_8intervals","a_Interaction_Fixed")
tresholdByConditionInteraction = as.data.frame(tresholdByConditionInteraction)

# Calculate threshold per condition
thresholdEveryCondition = as.data.frame(matrix(1,length(tresholdByConditionInteraction$a_Interaction_2intervals)))

thresholdEveryCondition$Threshold_2intervals_Speed = tresholdByCondition$a_Main_2intervals + tresholdByConditionInteraction$a_Interaction_2intervals 
thresholdEveryCondition$Threshold_2intervals_Accuracy = tresholdByCondition$a_Main_2intervals - tresholdByConditionInteraction$a_Interaction_2intervals 
thresholdEveryCondition$Threshold_2intervals = thresholdEveryCondition$Threshold_2intervals_Accuracy - thresholdEveryCondition$Threshold_2intervals_Speed

thresholdEveryCondition$Threshold_4intervals_Speed = tresholdByCondition$a_Main_4intervals + tresholdByConditionInteraction$a_Interaction_4intervals 
thresholdEveryCondition$Threshold_4intervals_Accuracy = tresholdByCondition$a_Main_4intervals - tresholdByConditionInteraction$a_Interaction_4intervals
thresholdEveryCondition$Threshold_4intervals = thresholdEveryCondition$Threshold_4intervals_Accuracy - thresholdEveryCondition$Threshold_4intervals_Speed


thresholdEveryCondition$Threshold_8intervals_Speed = tresholdByCondition$a_Main_8intervals + tresholdByConditionInteraction$a_Interaction_8intervals 
thresholdEveryCondition$Threshold_8intervals_Accuracy = tresholdByCondition$a_Main_8intervals - tresholdByConditionInteraction$a_Interaction_8intervals
thresholdEveryCondition$Threshold_8intervals = thresholdEveryCondition$Threshold_8intervals_Accuracy - thresholdEveryCondition$Threshold_8intervals_Speed


thresholdEveryCondition$Threshold_Fixed_Speed = tresholdByCondition$a_Main_Fixed + tresholdByConditionInteraction$a_Interaction_Fixed 
thresholdEveryCondition$Threshold_Fixed_Accuracy = tresholdByCondition$a_Main_Fixed - tresholdByConditionInteraction$a_Interaction_Fixed
thresholdEveryCondition$Threshold_Fixed = thresholdEveryCondition$Threshold_Fixed_Accuracy - thresholdEveryCondition$Threshold_Fixed_Speed


thresholdEveryCondition = thresholdEveryCondition[,-1]


output <- test.params(thresholdEveryCondition)


# Transform drift main effects
driftTransform = traces[,c("v_Intercept",
                               "v_C.blockType..Poly..Linear",
                               "v_C.blockType..Poly..Quadratic",
                               "v_C.blockType..Poly..Cubic")]

contrastMatrix = cbind(c(1,1,1,1),contr.poly(4))

driftByCondition = t(as.matrix(contrastMatrix) %*% t(as.matrix(driftTransform)))
colnames(driftByCondition) = c("v_Main_2intervals", "v_Main_4intervals", "v_Main_8intervals","v_Main_Fixed")
driftByCondition = as.data.frame(driftByCondition)



# Transform drift interactions
driftTransform = traces[,c("v_C.intervalType..Sum..S.Speed.",
                               "v_C.intervalType..Sum..S.Speed..C.blockType..Poly..Linear",
                               "v_C.intervalType..Sum..S.Speed..C.blockType..Poly..Quadratic",
                               "v_C.intervalType..Sum..S.Speed..C.blockType..Poly..Cubic")]

contrastMatrix = cbind(c(1,1,1,1),contr.poly(4))

driftByConditionInteraction = t(as.matrix(contrastMatrix) %*% t(as.matrix(driftTransform)))
colnames(driftByConditionInteraction) = c("v_Interaction_2intervals", "v_Interaction_4intervals", "v_Interaction_8intervals","v_Interaction_Fixed")
driftByConditionInteraction = as.data.frame(driftByConditionInteraction)


# Calculate drift per condition
driftEveryCondition = as.data.frame(matrix(1,length(driftByConditionInteraction$v_Interaction_2intervals)))

driftEveryCondition$Drift_2intervals_Speed = driftByCondition$v_Main_2intervals + driftByConditionInteraction$v_Interaction_2intervals 
driftEveryCondition$Drift_2intervals_Accuracy = driftByCondition$v_Main_2intervals - driftByConditionInteraction$v_Interaction_2intervals 
driftEveryCondition$Drift_2intervals = driftEveryCondition$Drift_2intervals_Accuracy - driftEveryCondition$Drift_2intervals_Speed

driftEveryCondition$Drift_4intervals_Speed = driftByCondition$v_Main_4intervals + driftByConditionInteraction$v_Interaction_4intervals 
driftEveryCondition$Drift_4intervals_Accuracy = driftByCondition$v_Main_4intervals - driftByConditionInteraction$v_Interaction_4intervals
driftEveryCondition$Drift_4intervals = driftEveryCondition$Drift_4intervals_Accuracy - driftEveryCondition$Drift_4intervals_Speed


driftEveryCondition$Drift_8intervals_Speed = driftByCondition$v_Main_8intervals + driftByConditionInteraction$v_Interaction_8intervals 
driftEveryCondition$Drift_8intervals_Accuracy = driftByCondition$v_Main_8intervals - driftByConditionInteraction$v_Interaction_8intervals
driftEveryCondition$Drift_8intervals = driftEveryCondition$Drift_8intervals_Accuracy - driftEveryCondition$Drift_8intervals_Speed


driftEveryCondition$Drift_Fixed_Speed = driftByCondition$v_Main_Fixed + driftByConditionInteraction$v_Interaction_Fixed 
driftEveryCondition$Drift_Fixed_Accuracy = driftByCondition$v_Main_Fixed - driftByConditionInteraction$v_Interaction_Fixed
driftEveryCondition$Drift_Fixed = driftEveryCondition$Drift_Fixed_Accuracy - driftEveryCondition$Drift_Fixed_Speed


driftEveryCondition = driftEveryCondition[,-1]

output <- test.params(driftEveryCondition)

                                 
### Summaries

summary = cbind(driftByCondition,driftByConditionInteraction,tresholdByCondition,tresholdByConditionInteraction)

output <- test.params(summary)

va <- output %>% separate(parameter,c('parameter','effect','block'),'_')

labels <- c('Threshold','Drift')

va$effect = as.factor(va$effect)

va$block = as.factor(va$block)

va$parameter<-factor(va$parameter,labels=c('Threshold','Drift Rate'))


```


## Drift rate and threshold


### Bar plot

```{r, message=FALSE}


output1 <- test.params(driftEveryCondition)
output2 = test.params(thresholdEveryCondition)

output = rbind(output1,output2)

output = output[c(3,6,9,12,15,18,21,24),]
                                 
va <- output %>% separate(parameter,c('parameter','block'),'_')

# Change the labels

va$block = factor(va$block, labels = c("Switch 2","Switch 4","Switch 8","Fixed"))
va$block = as.factor(va$block)
va$block = ordered(va$block, levels = c("Fixed","Switch 8","Switch 4","Switch 2"))

va$parameter<-factor(va$parameter,levels = c("Drift","Threshold"))


va$plotting = c(4,3,2,1,4,3,2,1)

# Plot
p<-ggplot(va,aes(x=plotting, y=Mean,fill=block)) +
  geom_bar(width=1,stat="identity", position=position_dodge(0.6)) +
  geom_errorbar(width=.1, size=1.1, position=position_dodge(width = .6),aes(ymin=CI_lower,ymax=CI_upper)) + ylab('Estimate') +
  facet_wrap(vars(parameter), labeller = as_labeller(c('Drift'="Drift rate",'Threshold'="Threshold")))+
  ylim(-0.05,0.5)+
  geom_hline(yintercept=0) +
  scale_fill_viridis(discrete = TRUE ,option = "plasma",end=0.7)+
  scale_x_discrete(expand = c(0.3,0.3))+
  theme(axis.line = element_line(colour = "black"),plot.margin=grid::unit(c(5,5,5,5), "mm"),
        axis.title.y = element_text(margin = margin(t = 0, r = 0, b = 0, l = 0)),
        text = element_text(size=33),
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        panel.border = element_blank(),
        panel.background = element_blank(),
        axis.title.x=element_blank(),
        axis.text.x = element_text(color="black"),
        axis.text.y = element_text(color="black"),
        axis.ticks = element_line(color = "black"),
        legend.position = c(0.78, 0.90),
        legend.background = element_rect(fill = "transparent", color = NA))  
        
p



```

### Points in 2D 

```{r, message=FALSE}


drift.rate<- test.params(driftEveryCondition)[-c(3,6,9,12),]

threshold<- test.params(thresholdEveryCondition)[-c(3,6,9,12),]


va <- rbind(drift.rate,threshold) %>% separate(parameter,c('parameter','fixed','factor'),'_')

va$factor = as.factor(va$factor)

# va$parameter<-factor(va$parameter,labels=c('Threshold','Drift Rate'))


# data = subset(va,fixed=="Varying")
# data = subset(va,isi=="ISI250")

data = va

# data$parameter = c("Drift","Drift","Drift","Drift","Threshold","Threshold","Threshold","Threshold")

# Long to wide
data = pivot_wider(data = data, 
            id_cols = c(factor,fixed), 
            names_from = parameter, 
            values_from = c("Mean","CI_lower","CI_upper"))

# data$factor = c("Speed", "Accuracy","Speed", "Accuracy")

data$factor = factor(data$factor, levels = c("Speed", "Accuracy"))
levels(data$factor) = c("Speed", "Accuracy")

data$fixed = factor(data$fixed, levels = c("Fixed","8intervals","4intervals","2intervals"))

# data$factor = c("Speed", "Accuracy","Speed & Accuracy" )

p<-ggplot(data,aes(x=Mean_Drift, y=Mean_Threshold,color=factor)) +
  geom_point(size=5) +
  geom_errorbar(width=0, linewidth=1.1, position=position_dodge(width = .6),aes(xmin=CI_lower_Drift,xmax=CI_upper_Drift)) +
  geom_errorbar(width=0, linewidth=1.1, position=position_dodge(width = .6),aes(ymin=CI_lower_Threshold,ymax=CI_upper_Threshold))+
  scale_color_viridis(discrete = TRUE ,option = "plasma",end=0.7)+
  facet_wrap(~fixed,nrow=1) +
  ylab("Threshold") + 
  xlab("Drift Rate") + 
  scale_x_continuous(limits = c(2.4,3.6))+
  scale_y_continuous(limits = c(0.6,1.1))+
  theme(axis.line = element_line(colour = "black"),
        plot.margin=grid::unit(c(5,5,5,5), "mm"),
        axis.title.y = element_text(margin = margin(t = 0, r = 0, b = 0, l = 0),color="black"),
        text = element_text(size=33,color = "black"),
        panel.border = element_rect (colour = "black", fill = F),
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        panel.background = element_blank(),
        axis.text.x = element_text(color="black"),
        axis.text.y = element_text(color="black"),
        axis.ticks = element_line(color = "black"),
        legend.position = "none")  

p







```


## Stats

### Drift rate (2-way interaction)


```{r, message=FALSE}


Interaction = summary_traces$v_C.intervalType..Sum..S.Speed..C.blockType..Poly..Linear 

Interaction = as.data.frame(Interaction)
h = (hypothesis(Interaction,"Interaction<0"))
kable(as.data.frame(h$hypothesis),caption="Interaction Drift")


# Plot
p = ggplot(data=Interaction,aes(x=Interaction)) + 
  geom_histogram(bins = 30,fill="transparent",color="black") + 
  geom_vline(xintercept=0,linetype="dashed",size=1.3) +
  xlab("Drift rate") + 
  ylab("Frequency") + 
  ggtitle("S/A x block") + 
  # scale_x_continuous(limits = c(-0.7,0.7))+
  # scale_y_continuous(limits = c(0,2600),expand = c(0,0))+
  theme(axis.line = element_line(colour = "black"),plot.margin=grid::unit(c(5,5,5,5), "mm"),
        axis.title.y = element_text(margin = margin(t = 0, r = 0, b = 0, l = 0),color="black"),
        text = element_text(size=33),
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        panel.border = element_blank(),
        panel.background = element_blank(),
        axis.text.x = element_text(color="black"),
        axis.text.y = element_text(color="black"),
        axis.ticks = element_line(color = "black"),
        legend.position = c(0.30, 0.85),
        legend.background = element_rect(fill = "transparent", color = NA)) 

p


Fig5.DDM_Diff_V = p


```


### Threshold (2-way interaction)


```{r, message=FALSE}


Interaction = summary_traces$a_C.intervalType..Sum..S.Speed..C.blockType..Poly..Linear 

Interaction = as.data.frame(Interaction)
h = (hypothesis(Interaction,"Interaction<0"))
kable(as.data.frame(h$hypothesis),caption="Interaction Threshold")


# Plot
p = ggplot(data=Interaction,aes(x=Interaction)) + 
  geom_histogram(bins = 30,fill="transparent",color="black") + 
  geom_vline(xintercept=0,linetype="dashed",size=1.3) +
  xlab("Threshold") + 
  ylab("Frequency") + 
  ggtitle("S/A x block") + 
  # scale_x_continuous(limits = c(-0.7,0.7))+
  # scale_y_continuous(limits = c(0,2600),expand = c(0,0))+
  theme(axis.line = element_line(colour = "black"),plot.margin=grid::unit(c(5,5,5,5), "mm"),
        axis.title.y = element_text(margin = margin(t = 0, r = 0, b = 0, l = 0),color="black"),
        text = element_text(size=33),
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        panel.border = element_blank(),
        panel.background = element_blank(),
        axis.text.x = element_text(color="black"),
        axis.text.y = element_text(color="black"),
        axis.ticks = element_line(color = "black"),
        legend.position = c(0.30, 0.85),
        legend.background = element_rect(fill = "transparent", color = NA)) 

p


Fig5.DDM_Diff_A = p


```


## Results summary


```{r, message=FALSE}

# # Drift rate interaction
# post = as.data.frame(driftTransform)
# post = post["v_C.intervalType..Sum..S.Speed..C.blockType..Poly..Linear"]
#    
# ggplot(data=post,aes(x=post$`v_C.intervalType..Sum..S.Speed..C.blockType..Poly..Linear`)) + 
#      geom_histogram(bins=50) + 
#      geom_vline(xintercept=0, linetype="dotted",size=1) +
#      labs(title=paste("Acc-Speed","p<0 = ",length(post[post<0])/length(post$`v_C.intervalType..Sum..S.Speed..C.blockType..Poly..Linear`))) +
#      theme_classic() 
# 
# 
# # Threshold interaction
# post = as.data.frame(thresholdTransform)
# post = post["a_C.intervalType..Sum..S.Speed..C.blockType..Poly..Linear"]
#    ggplot(data=post,aes(x=post$`a_C.intervalType..Sum..S.Speed..C.blockType..Poly..Linear`)) + 
#      geom_histogram(bins=50) + 
#      geom_vline(xintercept=0, linetype="dotted",size=1) +
#      labs(title=paste("Acc-Speed","p<0 = ",length(post[post<0])/length(post$`a_C.intervalType..Sum..S.Speed..C.blockType..Poly..Linear`))) +
#      theme_classic() 






```



# Main analyses - Interval type x Block type on NDT


## Rhats

```{r, message=FALSE}
# Import the Rhats
rhats <- fread('output/Mixed/ae_only/modelMixed2/modelMixed2_RHat.csv', header = T)
colnames(rhats) = c("parameter","Rhat")


# Plot the Rhats

# Set parameters for plots
set_theme(base =theme_bw(base_size = 15, base_family = "")) # font size and theme
myColors = brewer.pal(3,"Set2") #colors
barfill <- "#4271AE"
barlines <- "#1F3552"

p =ggplot(rhats, aes(Rhat)) +
  geom_histogram(colour = barlines, fill = barfill,binwidth = 0.01)+ #colour = barlines, fill = barfill
  theme_bw() +
  labs(x = "Rhat", y = "Count\n")+
  theme(axis.line = element_line(size=1, colour = "black"),
        panel.grid.major = element_line(colour = "grey",size = 0.1,linetype = "dashed"),
        panel.grid.minor = element_line(colour = "grey",size = 0.1,linetype = "dashed"),
        panel.border = element_blank(),
        panel.background = element_blank(),
        plot.title = element_text(size = 18,  face = "bold",hjust = 0.5),
        text=element_text(colour="black", size = 14),
        axis.text.x=element_text(colour="black", size = 14),
        axis.text.y=element_text(colour="black", size = 14, face = "plain",hjust=0),
        axis.title=element_text(size=18,colour = "black",vjust = 1))

p


# Print the names of the low Rhat parameters
highRhats = subset(rhats,rhats$Rhat>1.1)
highRhats
```



## Trace plots


```{r, message=FALSE}
traces <- read.csv('output/Mixed/ae_only/modelMixed2/modelMixed2_traces.csv')

traces<-traces %>% dplyr::select(a_Intercept,
                                 a_C.intervalType..Sum..S.Speed.,
                                 a_C.blockType..Poly..Linear,
                                 a_C.blockType..Poly..Quadratic,
                                 a_C.blockType..Poly..Cubic,
                                 a_C.intervalType..Sum..S.Speed..C.blockType..Poly..Linear,
                                 a_C.intervalType..Sum..S.Speed..C.blockType..Poly..Quadratic,
                                 a_C.intervalType..Sum..S.Speed..C.blockType..Poly..Cubic,
                                 
                                 v_Intercept,
                                 v_C.intervalType..Sum..S.Speed.,
                                 v_C.congruency..Sum..S.incongruent.,
                                 v_C.blockType..Poly..Linear,
                                 v_C.blockType..Poly..Quadratic,
                                 v_C.blockType..Poly..Cubic,
                                 v_C.intervalType..Sum..S.Speed..C.blockType..Poly..Linear,
                                 v_C.intervalType..Sum..S.Speed..C.blockType..Poly..Quadratic,
                                 v_C.intervalType..Sum..S.Speed..C.blockType..Poly..Cubic,

                                 t_Intercept,
                                 t_C.intervalType..Sum..S.Speed.,
                                 t_C.blockType..Poly..Linear,
                                 t_C.blockType..Poly..Quadratic,
                                 t_C.blockType..Poly..Cubic,
                                 t_C.intervalType..Sum..S.Speed..C.blockType..Poly..Linear,
                                 t_C.intervalType..Sum..S.Speed..C.blockType..Poly..Quadratic,
                                 t_C.intervalType..Sum..S.Speed..C.blockType..Poly..Cubic)%>%
                          
  mutate(a_Intercept=0.5*a_Intercept,
         a_C.intervalType..Sum..S.Speed.=0.5*a_C.intervalType..Sum..S.Speed.,
         a_C.blockType..Poly..Linear=0.5*a_C.blockType..Poly..Linear,
         a_C.blockType..Poly..Quadratic=0.5*a_C.blockType..Poly..Quadratic,
         a_C.blockType..Poly..Cubic=0.5*a_C.blockType..Poly..Cubic,
         a_C.intervalType..Sum..S.Speed..C.blockType..Poly..Linear=0.5*a_C.intervalType..Sum..S.Speed..C.blockType..Poly..Linear,
         a_C.intervalType..Sum..S.Speed..C.blockType..Poly..Quadratic=0.5*a_C.intervalType..Sum..S.Speed..C.blockType..Poly..Quadratic,
         a_C.intervalType..Sum..S.Speed..C.blockType..Poly..Cubic=0.5*a_C.intervalType..Sum..S.Speed..C.blockType..Poly..Cubic)



# For each parameter
colNames= names(traces)

for (parameter in colNames) {

  #Plotting
  plot_data1 = traces[1:2000,]
  plot_data2 = traces[2001:4000,]
  plot_data3 = traces[4001:6000,]
  plot_data4 = traces[6001:8000,]
  plot_data5 = traces[8001:10000,]



  traces_plot = ggplot(NULL) +

    # Chain 1
    geom_line(data=plot_data1,mapping =aes_string(y=parameter,x = 1:2000), colour="red")+

    # Chain 2
    geom_line(data=plot_data2,mapping =aes_string(y=parameter,x = 1:2000), colour="royalblue1")+

    # Chain 3
    geom_line(data=plot_data3,mapping =aes_string(y=parameter,x = 1:2000), colour="springgreen")+

    # Chain 4
    geom_line(data=plot_data4,mapping =aes_string(y=parameter,x = 1:2000), colour="grey0")+

    # Chain 5
    geom_line(data=plot_data5,mapping =aes_string(y=parameter,x = 1:2000), colour="coral")+
    theme_classic(base_size = 18) +

    ggtitle(parameter)  + ylab("Parameter value") + xlab("Sample")



  print(traces_plot)
}
```




## PPCs


```{r, message=FALSE}

df.ppc <- fread('output/Mixed/ae_only/modelMixed2/modelMixed2_simData.csv') %>%
  mutate(simResponse=rt_sampled>0,
         Response=rt>0,
         rt_unsigned = abs(rt),
         rt_sampled_unsigned = abs(rt_sampled))

df.ppc.sim <- df.ppc %>% filter(sample==0,rt_sampled_unsigned<=3)

df.ppc.data <- df.ppc %>% filter(sample==0,rt_unsigned<=3)

ratio.true <- sum(!df.ppc.data$Response)/sum(df.ppc.data$Response)

ratio.simu <- sum(!df.ppc.sim$simResponse)/sum(df.ppc.sim$simResponse)

# Density plots with means
ggplot(df.ppc.data %>% filter(Response),
       aes(x=rt_unsigned,color='Correct',linetype='True')) +
  geom_density(size=1) +
  geom_density(data=df.ppc.data %>% filter(!Response),
               size=1,
               aes(x=rt_unsigned,y=-..density..*ratio.true,color='Incorrect',linetype='True'),
  ) +
  geom_density(data=df.ppc.sim %>% filter(simResponse),
               size=1,
               aes(x=rt_sampled_unsigned,color='Correct',linetype='Simulation')) +
  geom_density(data=df.ppc.sim %>% filter(!simResponse),
               size=1,
               aes(x=rt_sampled_unsigned,y=-..density..*ratio.simu,color='Incorrect',linetype='Simulation'),
  ) + geom_hline(yintercept=0) + ggdensity +
  xlab('Reaction Time') + coord_cartesian(xlim=c(0,2)) + facet_grid(cols=vars(intervalType,blockType)) + scale_linetype_manual(name='Data:',values=c('Simulation'=1,'True'=2)) + scale_color_manual(name='Response:',values=c('Correct'='blue','Incorrect'='red'))
```





## Import the posteriors


```{r, message=FALSE}
traces <- read.csv('output/Mixed/ae_only/modelMixed2/modelMixed2_traces.csv')


traces<-traces %>% dplyr::select(a_Intercept,
                                 a_C.intervalType..Sum..S.Speed.,
                                 a_C.blockType..Poly..Linear,
                                 a_C.blockType..Poly..Quadratic,
                                 a_C.blockType..Poly..Cubic,
                                 a_C.intervalType..Sum..S.Speed..C.blockType..Poly..Linear,
                                 a_C.intervalType..Sum..S.Speed..C.blockType..Poly..Quadratic,
                                 a_C.intervalType..Sum..S.Speed..C.blockType..Poly..Cubic,
                                 
                                 v_Intercept,
                                 v_C.intervalType..Sum..S.Speed.,
                                 v_C.congruency..Sum..S.incongruent.,
                                 v_C.blockType..Poly..Linear,
                                 v_C.blockType..Poly..Quadratic,
                                 v_C.blockType..Poly..Cubic,
                                 v_C.intervalType..Sum..S.Speed..C.blockType..Poly..Linear,
                                 v_C.intervalType..Sum..S.Speed..C.blockType..Poly..Quadratic,
                                 v_C.intervalType..Sum..S.Speed..C.blockType..Poly..Cubic,

                                 t_Intercept,
                                 t_C.intervalType..Sum..S.Speed.,
                                 t_C.blockType..Poly..Linear,
                                 t_C.blockType..Poly..Quadratic,
                                 t_C.blockType..Poly..Cubic,
                                 t_C.intervalType..Sum..S.Speed..C.blockType..Poly..Linear,
                                 t_C.intervalType..Sum..S.Speed..C.blockType..Poly..Quadratic,
                                 t_C.intervalType..Sum..S.Speed..C.blockType..Poly..Cubic)%>%
                          
  mutate(a_Intercept=0.5*a_Intercept,
         a_C.intervalType..Sum..S.Speed.=0.5*a_C.intervalType..Sum..S.Speed.,
         a_C.blockType..Poly..Linear=0.5*a_C.blockType..Poly..Linear,
         a_C.blockType..Poly..Quadratic=0.5*a_C.blockType..Poly..Quadratic,
         a_C.blockType..Poly..Cubic=0.5*a_C.blockType..Poly..Cubic,
         a_C.intervalType..Sum..S.Speed..C.blockType..Poly..Linear=0.5*a_C.intervalType..Sum..S.Speed..C.blockType..Poly..Linear,
         a_C.intervalType..Sum..S.Speed..C.blockType..Poly..Quadratic=0.5*a_C.intervalType..Sum..S.Speed..C.blockType..Poly..Quadratic,
         a_C.intervalType..Sum..S.Speed..C.blockType..Poly..Cubic=0.5*a_C.intervalType..Sum..S.Speed..C.blockType..Poly..Cubic)

```

## Parameter estimates
```{r, message=FALSE}
summary_traces = traces

# Get the correct estimates (relative to sum & poly coding)
summary_traces$a_C.intervalType..Sum..S.Speed. = summary_traces$a_C.intervalType..Sum..S.Speed. * 2
summary_traces$v_C.intervalType..Sum..S.Speed. = summary_traces$v_C.intervalType..Sum..S.Speed. * 2
summary_traces$t_C.intervalType..Sum..S.Speed. = summary_traces$t_C.intervalType..Sum..S.Speed. * 2


summary_traces$a_C.intervalType..Sum..S.Speed..C.blockType..Poly..Linear = (summary_traces$a_C.intervalType..Sum..S.Speed..C.blockType..Poly..Linear/0.6708204) * 2
summary_traces$v_C.intervalType..Sum..S.Speed..C.blockType..Poly..Linear = (summary_traces$v_C.intervalType..Sum..S.Speed..C.blockType..Poly..Linear/0.6708204) * 2
summary_traces$t_C.intervalType..Sum..S.Speed..C.blockType..Poly..Linear = (summary_traces$t_C.intervalType..Sum..S.Speed..C.blockType..Poly..Linear/0.6708204) * 2


output <- test.params(summary_traces)
kable(output)
```


## Transform the traces
```{r, message=FALSE}
# Transform thresholds main effects
thresholdTransform = traces[,c("a_Intercept",
                               "a_C.blockType..Poly..Linear",
                               "a_C.blockType..Poly..Quadratic",
                               "a_C.blockType..Poly..Cubic")]

contrastMatrix = cbind(c(1,1,1,1),contr.poly(4))

tresholdByCondition = t(as.matrix(contrastMatrix) %*% t(as.matrix(thresholdTransform)))
colnames(tresholdByCondition) = c("a_Main_2intervals", "a_Main_4intervals", "a_Main_8intervals","a_Main_Fixed")
tresholdByCondition = as.data.frame(tresholdByCondition)



# Transform thresholds interactions
thresholdTransform = traces[,c("a_C.intervalType..Sum..S.Speed.",
                               "a_C.intervalType..Sum..S.Speed..C.blockType..Poly..Linear",
                               "a_C.intervalType..Sum..S.Speed..C.blockType..Poly..Quadratic",
                               "a_C.intervalType..Sum..S.Speed..C.blockType..Poly..Cubic")]

contrastMatrix = cbind(c(1,1,1,1),contr.poly(4))

tresholdByConditionInteraction = t(as.matrix(contrastMatrix) %*% t(as.matrix(thresholdTransform)))
colnames(tresholdByConditionInteraction) = c("a_Interaction_2intervals", "a_Interaction_4intervals", "a_Interaction_8intervals","a_Interaction_Fixed")
tresholdByConditionInteraction = as.data.frame(tresholdByConditionInteraction)

# Calculate threshold per condition
thresholdEveryCondition = as.data.frame(matrix(1,length(tresholdByConditionInteraction$a_Interaction_2intervals)))

thresholdEveryCondition$Threshold_2intervals_Speed = tresholdByCondition$a_Main_2intervals + tresholdByConditionInteraction$a_Interaction_2intervals 
thresholdEveryCondition$Threshold_2intervals_Accuracy = tresholdByCondition$a_Main_2intervals - tresholdByConditionInteraction$a_Interaction_2intervals 
thresholdEveryCondition$Threshold_2intervals = thresholdEveryCondition$Threshold_2intervals_Accuracy - thresholdEveryCondition$Threshold_2intervals_Speed

thresholdEveryCondition$Threshold_4intervals_Speed = tresholdByCondition$a_Main_4intervals + tresholdByConditionInteraction$a_Interaction_4intervals 
thresholdEveryCondition$Threshold_4intervals_Accuracy = tresholdByCondition$a_Main_4intervals - tresholdByConditionInteraction$a_Interaction_4intervals
thresholdEveryCondition$Threshold_4intervals = thresholdEveryCondition$Threshold_4intervals_Accuracy - thresholdEveryCondition$Threshold_4intervals_Speed


thresholdEveryCondition$Threshold_8intervals_Speed = tresholdByCondition$a_Main_8intervals + tresholdByConditionInteraction$a_Interaction_8intervals 
thresholdEveryCondition$Threshold_8intervals_Accuracy = tresholdByCondition$a_Main_8intervals - tresholdByConditionInteraction$a_Interaction_8intervals
thresholdEveryCondition$Threshold_8intervals = thresholdEveryCondition$Threshold_8intervals_Accuracy - thresholdEveryCondition$Threshold_8intervals_Speed


thresholdEveryCondition$Threshold_Fixed_Speed = tresholdByCondition$a_Main_Fixed + tresholdByConditionInteraction$a_Interaction_Fixed 
thresholdEveryCondition$Threshold_Fixed_Accuracy = tresholdByCondition$a_Main_Fixed - tresholdByConditionInteraction$a_Interaction_Fixed
thresholdEveryCondition$Threshold_Fixed = thresholdEveryCondition$Threshold_Fixed_Accuracy - thresholdEveryCondition$Threshold_Fixed_Speed


thresholdEveryCondition = thresholdEveryCondition[,-1]


output <- test.params(thresholdEveryCondition)


# Transform drift main effects
driftTransform = traces[,c("v_Intercept",
                               "v_C.blockType..Poly..Linear",
                               "v_C.blockType..Poly..Quadratic",
                               "v_C.blockType..Poly..Cubic")]

contrastMatrix = cbind(c(1,1,1,1),contr.poly(4))

driftByCondition = t(as.matrix(contrastMatrix) %*% t(as.matrix(driftTransform)))
colnames(driftByCondition) = c("v_Main_2intervals", "v_Main_4intervals", "v_Main_8intervals","v_Main_Fixed")
driftByCondition = as.data.frame(driftByCondition)



# Transform drift interactions
driftTransform = traces[,c("v_C.intervalType..Sum..S.Speed.",
                               "v_C.intervalType..Sum..S.Speed..C.blockType..Poly..Linear",
                               "v_C.intervalType..Sum..S.Speed..C.blockType..Poly..Quadratic",
                               "v_C.intervalType..Sum..S.Speed..C.blockType..Poly..Cubic")]

contrastMatrix = cbind(c(1,1,1,1),contr.poly(4))

driftByConditionInteraction = t(as.matrix(contrastMatrix) %*% t(as.matrix(driftTransform)))
colnames(driftByConditionInteraction) = c("v_Interaction_2intervals", "v_Interaction_4intervals", "v_Interaction_8intervals","v_Interaction_Fixed")
driftByConditionInteraction = as.data.frame(driftByConditionInteraction)


# Calculate drift per condition
driftEveryCondition = as.data.frame(matrix(1,length(driftByConditionInteraction$v_Interaction_2intervals)))

driftEveryCondition$Drift_2intervals_Speed = driftByCondition$v_Main_2intervals + driftByConditionInteraction$v_Interaction_2intervals 
driftEveryCondition$Drift_2intervals_Accuracy = driftByCondition$v_Main_2intervals - driftByConditionInteraction$v_Interaction_2intervals 
driftEveryCondition$Drift_2intervals = driftEveryCondition$Drift_2intervals_Accuracy - driftEveryCondition$Drift_2intervals_Speed

driftEveryCondition$Drift_4intervals_Speed = driftByCondition$v_Main_4intervals + driftByConditionInteraction$v_Interaction_4intervals 
driftEveryCondition$Drift_4intervals_Accuracy = driftByCondition$v_Main_4intervals - driftByConditionInteraction$v_Interaction_4intervals
driftEveryCondition$Drift_4intervals = driftEveryCondition$Drift_4intervals_Accuracy - driftEveryCondition$Drift_4intervals_Speed


driftEveryCondition$Drift_8intervals_Speed = driftByCondition$v_Main_8intervals + driftByConditionInteraction$v_Interaction_8intervals 
driftEveryCondition$Drift_8intervals_Accuracy = driftByCondition$v_Main_8intervals - driftByConditionInteraction$v_Interaction_8intervals
driftEveryCondition$Drift_8intervals = driftEveryCondition$Drift_8intervals_Accuracy - driftEveryCondition$Drift_8intervals_Speed


driftEveryCondition$Drift_Fixed_Speed = driftByCondition$v_Main_Fixed + driftByConditionInteraction$v_Interaction_Fixed 
driftEveryCondition$Drift_Fixed_Accuracy = driftByCondition$v_Main_Fixed - driftByConditionInteraction$v_Interaction_Fixed
driftEveryCondition$Drift_Fixed = driftEveryCondition$Drift_Fixed_Accuracy - driftEveryCondition$Drift_Fixed_Speed


driftEveryCondition = driftEveryCondition[,-1]

output <- test.params(driftEveryCondition)


# Transform NDT main effects
ndtTransform = traces[,c("t_Intercept",
                               "t_C.blockType..Poly..Linear",
                               "t_C.blockType..Poly..Quadratic",
                               "t_C.blockType..Poly..Cubic")]

contrastMatrix = cbind(c(1,1,1,1),contr.poly(4))

ndtByCondition = t(as.matrix(contrastMatrix) %*% t(as.matrix(ndtTransform)))
colnames(ndtByCondition) = c("t_Main_2intervals", "t_Main_4intervals", "t_Main_8intervals","t_Main_Fixed")
ndtByCondition = as.data.frame(ndtByCondition)



# Transform drift interactions
ndtTransform = traces[,c("t_C.intervalType..Sum..S.Speed.",
                               "t_C.intervalType..Sum..S.Speed..C.blockType..Poly..Linear",
                               "t_C.intervalType..Sum..S.Speed..C.blockType..Poly..Quadratic",
                               "t_C.intervalType..Sum..S.Speed..C.blockType..Poly..Cubic")]

contrastMatrix = cbind(c(1,1,1,1),contr.poly(4))

ndtByConditionInteraction = t(as.matrix(contrastMatrix) %*% t(as.matrix(ndtTransform)))
colnames(ndtByConditionInteraction) = c("t_Interaction_2intervals", "t_Interaction_4intervals", "t_Interaction_8intervals","t_Interaction_Fixed")
ndtByConditionInteraction = as.data.frame(ndtByConditionInteraction)


# Calculate ndt per condition
ndtEveryCondition = as.data.frame(matrix(1,length(ndtByConditionInteraction$t_Interaction_2intervals)))

ndtEveryCondition$ndt_2intervals_Speed = ndtByCondition$t_Main_2intervals + ndtByConditionInteraction$t_Interaction_2intervals 
ndtEveryCondition$ndt_2intervals_Accuracy = ndtByCondition$t_Main_2intervals - ndtByConditionInteraction$t_Interaction_2intervals 
ndtEveryCondition$ndt_2intervals = ndtEveryCondition$ndt_2intervals_Accuracy - ndtEveryCondition$ndt_2intervals_Speed

ndtEveryCondition$ndt_4intervals_Speed = ndtByCondition$t_Main_4intervals + ndtByConditionInteraction$t_Interaction_4intervals 
ndtEveryCondition$ndt_4intervals_Accuracy = ndtByCondition$t_Main_4intervals - ndtByConditionInteraction$t_Interaction_4intervals
ndtEveryCondition$ndt_4intervals = ndtEveryCondition$ndt_4intervals_Accuracy - ndtEveryCondition$ndt_4intervals_Speed


ndtEveryCondition$ndt_8intervals_Speed = ndtByCondition$t_Main_8intervals + ndtByConditionInteraction$t_Interaction_8intervals 
ndtEveryCondition$ndt_8intervals_Accuracy = ndtByCondition$t_Main_8intervals - ndtByConditionInteraction$t_Interaction_8intervals
ndtEveryCondition$ndt_8intervals = ndtEveryCondition$ndt_8intervals_Accuracy - ndtEveryCondition$ndt_8intervals_Speed


ndtEveryCondition$ndt_Fixed_Speed = ndtByCondition$t_Main_Fixed + ndtByConditionInteraction$t_Interaction_Fixed 
ndtEveryCondition$ndt_Fixed_Accuracy = ndtByCondition$t_Main_Fixed - ndtByConditionInteraction$t_Interaction_Fixed
ndtEveryCondition$ndt_Fixed = ndtEveryCondition$ndt_Fixed_Accuracy - ndtEveryCondition$ndt_Fixed_Speed


ndtEveryCondition = ndtEveryCondition[,-1]

output <- test.params(ndtEveryCondition)

                                 
### Summaries

summary = cbind(driftByCondition,driftByConditionInteraction,tresholdByCondition,tresholdByConditionInteraction)

output <- test.params(summary)

va <- output %>% separate(parameter,c('parameter','effect','block'),'_')

labels <- c('Threshold','Drift')

va$effect = as.factor(va$effect)

va$block = as.factor(va$block)

va$parameter<-factor(va$parameter,labels=c('Threshold','Drift Rate'))


summary = cbind(ndtByCondition,ndtByConditionInteraction)

output <- test.params(summary)

ndt <- output %>% separate(parameter,c('parameter','effect','block'),'_')

ndt$effect = as.factor(ndt$effect)

ndt$block = as.factor(ndt$block)

ndt$parameter<-factor(ndt$parameter)

```


## Drift rate and threshold


### Bar plot

```{r, message=FALSE}


output1 <- test.params(driftEveryCondition)
output2 = test.params(thresholdEveryCondition)

output = rbind(output1,output2)

output = output[c(3,6,9,12,15,18,21,24),]
                                 
va <- output %>% separate(parameter,c('parameter','block'),'_')

# Change the labels

va$block = factor(va$block, labels = c("Switch 2","Switch 4","Switch 8","Fixed"))
va$block = as.factor(va$block)
va$block = ordered(va$block, levels = c("Fixed","Switch 8","Switch 4","Switch 2"))

va$parameter<-factor(va$parameter,levels = c("Drift","Threshold"))





Color1 = rgb(0.35, 0.35, 0.35)
Color2 = rgb(0.5, 0.5, 0.5)
Color3 = rgb(0.7, 0.7, 0.7)
Color4 = rgb(0.8, 0.8, 0.8)

va$plotting = c(4,3,2,1,4,3,2,1)

# Plot
p<-ggplot(va,aes(x=plotting, y=Mean,fill=block)) +
  geom_bar(width=1,stat="identity", position=position_dodge(0.6)) +
  geom_errorbar(width=.1, size=1.1, position=position_dodge(width = .6),aes(ymin=CI_lower,ymax=CI_upper)) + ylab('Estimate') +
  facet_wrap(vars(parameter), labeller = as_labeller(c('Drift'="Drift rate",'Threshold'="Threshold")))+
  ylim(-0.05,0.5)+
  geom_hline(yintercept=0) +
  scale_fill_viridis(discrete = TRUE ,option = "plasma",end=0.7)+
  scale_x_discrete(expand = c(0.3,0.3))+
  theme(axis.line = element_line(colour = "black"),plot.margin=grid::unit(c(5,5,5,5), "mm"),
        axis.title.y = element_text(margin = margin(t = 0, r = 0, b = 0, l = 0)),
        text = element_text(size=33),
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        panel.border = element_blank(),
        panel.background = element_blank(),
        axis.title.x=element_blank(),
        axis.text.x = element_text(color="black"),
        axis.text.y = element_text(color="black"),
        axis.ticks = element_line(color = "black"),
        legend.position = c(0.78, 0.90),
        legend.background = element_rect(fill = "transparent", color = NA))  
        
p





```

### Points in 2D 

```{r, message=FALSE}


drift.rate<- test.params(driftEveryCondition)[-c(3,6,9,12),]

threshold<- test.params(thresholdEveryCondition)[-c(3,6,9,12),]


va <- rbind(drift.rate,threshold) %>% separate(parameter,c('parameter','fixed','factor'),'_')

va$factor = as.factor(va$factor)

# va$parameter<-factor(va$parameter,labels=c('Threshold','Drift Rate'))


# data = subset(va,fixed=="Varying")
# data = subset(va,isi=="ISI250")

data = va

# data$parameter = c("Drift","Drift","Drift","Drift","Threshold","Threshold","Threshold","Threshold")

# Long to wide
data = pivot_wider(data = data, 
            id_cols = c(factor,fixed), 
            names_from = parameter, 
            values_from = c("Mean","CI_lower","CI_upper"))

# data$factor = c("Speed", "Accuracy","Speed", "Accuracy")

data$factor = factor(data$factor, levels = c("Speed", "Accuracy"))
levels(data$factor) = c("Speed", "Accuracy")

data$fixed = factor(data$fixed, levels = c("Fixed","8intervals","4intervals","2intervals"))

# data$factor = c("Speed", "Accuracy","Speed & Accuracy" )

p<-ggplot(data,aes(x=Mean_Drift, y=Mean_Threshold,color=factor)) +
  geom_point(size=5) +
  geom_errorbar(width=0, size=1.1, position=position_dodge(width = .6),aes(xmin=CI_lower_Drift,xmax=CI_upper_Drift)) +
  geom_errorbar(width=0, size=1.1, position=position_dodge(width = .6),aes(ymin=CI_lower_Threshold,ymax=CI_upper_Threshold))+
  scale_color_viridis(discrete = TRUE ,option = "plasma",end=0.7)+
  facet_wrap(~fixed,nrow=1) +
  ylab("Threshold") + 
  xlab("Drift Rate") + 
  scale_x_continuous(limits = c(2.4,3.6))+
  scale_y_continuous(limits = c(0.6,1.1))+
  theme(axis.line = element_line(colour = "black"),
        plot.margin=grid::unit(c(5,5,5,5), "mm"),
        axis.title.y = element_text(margin = margin(t = 0, r = 0, b = 0, l = 0),color="black"),
        text = element_text(size=33,color = "black"),
        panel.border = element_rect (colour = "black", fill = F),
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        panel.background = element_blank(),
        axis.text.x = element_text(color="black"),
        axis.text.y = element_text(color="black"),
        axis.ticks = element_line(color = "black"),
        legend.position = "none")  

p


```



## NDT 


### Bar plot

```{r, message=FALSE}


output <- test.params(ndtEveryCondition)

output = output[c(3,6,9,12),]
                                 
ndt <- output %>% separate(parameter,c('parameter','block'),'_')

# Change the labels

ndt$block = factor(ndt$block, labels = c("Switch 2","Switch 4","Switch 8","Fixed"))
ndt$block = as.factor(ndt$block)
ndt$block = ordered(ndt$block, levels = c("Fixed","Switch 8","Switch 4","Switch 2"))

ndt$parameter<-factor(ndt$parameter)


ndt$plotting = c(4,3,2,1)

# Plot
p<-ggplot(ndt,aes(x=plotting, y=Mean,fill=block)) +
  geom_bar(width=1,stat="identity", position=position_dodge(0.6)) +
  geom_errorbar(width=.1, size=1.1, position=position_dodge(width = .6),aes(ymin=CI_lower,ymax=CI_upper)) + ylab('Estimate') +
  facet_wrap(vars(parameter), labeller = as_labeller(c('Drift'="Drift rate",'Threshold'="Threshold")))+
  ylim(-0.05,0.5)+
  geom_hline(yintercept=0) +
  scale_fill_viridis(discrete = TRUE ,option = "plasma",end=0.7)+
  scale_x_discrete(expand = c(0.3,0.3))+
  theme(axis.line = element_line(colour = "black"),plot.margin=grid::unit(c(5,5,5,5), "mm"),
        axis.title.y = element_text(margin = margin(t = 0, r = 0, b = 0, l = 0)),
        text = element_text(size=33),
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        panel.border = element_blank(),
        panel.background = element_blank(),
        axis.title.x=element_blank(),
        axis.text.x = element_text(color="black"),
        axis.text.y = element_text(color="black"),
        axis.ticks = element_line(color = "black"),
        legend.position = c(0.78, 0.90),
        legend.background = element_rect(fill = "transparent", color = NA))  
        
p




```


## Stats

### Drift rate (2-way interaction)


```{r, message=FALSE}


Interaction = summary_traces$v_C.intervalType..Sum..S.Speed..C.blockType..Poly..Linear 

Interaction = as.data.frame(Interaction)
h = (hypothesis(Interaction,"Interaction<0"))
kable(as.data.frame(h$hypothesis),caption="Interaction Drift")


# Plot
p = ggplot(data=Interaction,aes(x=Interaction)) + 
  geom_histogram(bins = 30,fill="transparent",color="black") + 
  geom_vline(xintercept=0,linetype="dashed",size=1.3) +
  xlab("Drift rate") + 
  ylab("Frequency") + 
  ggtitle("S/A x block") + 
  # scale_x_continuous(limits = c(-0.7,0.7))+
  # scale_y_continuous(limits = c(0,2600),expand = c(0,0))+
  theme(axis.line = element_line(colour = "black"),plot.margin=grid::unit(c(5,5,5,5), "mm"),
        axis.title.y = element_text(margin = margin(t = 0, r = 0, b = 0, l = 0),color="black"),
        text = element_text(size=33),
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        panel.border = element_blank(),
        panel.background = element_blank(),
        axis.text.x = element_text(color="black"),
        axis.text.y = element_text(color="black"),
        axis.ticks = element_line(color = "black"),
        legend.position = c(0.30, 0.85),
        legend.background = element_rect(fill = "transparent", color = NA)) 

p


Fig5.DDM_Diff_V = p


```


### Threshold (2-way interaction)


```{r, message=FALSE}


Interaction = summary_traces$a_C.intervalType..Sum..S.Speed..C.blockType..Poly..Linear 

Interaction = as.data.frame(Interaction)
h = (hypothesis(Interaction,"Interaction<0"))
kable(as.data.frame(h$hypothesis),caption="Interaction Threshold")


# Plot
p = ggplot(data=Interaction,aes(x=Interaction)) + 
  geom_histogram(bins = 30,fill="transparent",color="black") + 
  geom_vline(xintercept=0,linetype="dashed",size=1.3) +
  xlab("Threshold") + 
  ylab("Frequency") + 
  ggtitle("S/A x block") + 
  # scale_x_continuous(limits = c(-0.7,0.7))+
  # scale_y_continuous(limits = c(0,2600),expand = c(0,0))+
  theme(axis.line = element_line(colour = "black"),plot.margin=grid::unit(c(5,5,5,5), "mm"),
        axis.title.y = element_text(margin = margin(t = 0, r = 0, b = 0, l = 0),color="black"),
        text = element_text(size=33),
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        panel.border = element_blank(),
        panel.background = element_blank(),
        axis.text.x = element_text(color="black"),
        axis.text.y = element_text(color="black"),
        axis.ticks = element_line(color = "black"),
        legend.position = c(0.30, 0.85),
        legend.background = element_rect(fill = "transparent", color = NA)) 

p


Fig5.DDM_Diff_A = p


```



### NDT (2-way interaction)


```{r, message=FALSE}


Interaction = summary_traces$t_C.intervalType..Sum..S.Speed..C.blockType..Poly..Linear 

Interaction = as.data.frame(Interaction)
h = (hypothesis(Interaction,"Interaction<0"))
kable(as.data.frame(h$hypothesis),caption="Interaction Threshold")


# Plot
p = ggplot(data=Interaction,aes(x=Interaction)) + 
  geom_histogram(bins = 30,fill="transparent",color="black") + 
  geom_vline(xintercept=0,linetype="dashed",size=1.3) +
  xlab("Threshold") + 
  ylab("Frequency") + 
  ggtitle("S/A x block") + 
  # scale_x_continuous(limits = c(-0.7,0.7))+
  # scale_y_continuous(limits = c(0,2600),expand = c(0,0))+
  theme(axis.line = element_line(colour = "black"),plot.margin=grid::unit(c(5,5,5,5), "mm"),
        axis.title.y = element_text(margin = margin(t = 0, r = 0, b = 0, l = 0),color="black"),
        text = element_text(size=33),
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        panel.border = element_blank(),
        panel.background = element_blank(),
        axis.text.x = element_text(color="black"),
        axis.text.y = element_text(color="black"),
        axis.ticks = element_line(color = "black"),
        legend.position = c(0.30, 0.85),
        legend.background = element_rect(fill = "transparent", color = NA)) 

p




```



## Results summary


```{r, message=FALSE}

# # Drift rate interaction
# post = as.data.frame(driftTransform)
# post = post["v_C.intervalType..Sum..S.Speed..C.blockType..Poly..Linear"]
#    
# ggplot(data=post,aes(x=post$`v_C.intervalType..Sum..S.Speed..C.blockType..Poly..Linear`)) + 
#      geom_histogram(bins=50) + 
#      geom_vline(xintercept=0, linetype="dotted",size=1) +
#      labs(title=paste("Acc-Speed","p<0 = ",length(post[post<0])/length(post$`v_C.intervalType..Sum..S.Speed..C.blockType..Poly..Linear`))) +
#      theme_classic() 
# 
# 
# # Threshold interaction
# post = as.data.frame(thresholdTransform)
# post = post["a_C.intervalType..Sum..S.Speed..C.blockType..Poly..Linear"]
#    ggplot(data=post,aes(x=post$`a_C.intervalType..Sum..S.Speed..C.blockType..Poly..Linear`)) + 
#      geom_histogram(bins=50) + 
#      geom_vline(xintercept=0, linetype="dotted",size=1) +
#      labs(title=paste("Acc-Speed","p<0 = ",length(post[post<0])/length(post$`a_C.intervalType..Sum..S.Speed..C.blockType..Poly..Linear`))) +
#      theme_classic() 






```




# Main analyses - Intercept on NDT


## Rhats

```{r, message=FALSE}
# Import the Rhats
rhats <- fread('output/Mixed/ae_only/modelMixed3/modelMixed3_RHat.csv', header = T)
colnames(rhats) = c("parameter","Rhat")


# Plot the Rhats

# Set parameters for plots
set_theme(base =theme_bw(base_size = 15, base_family = "")) # font size and theme
myColors = brewer.pal(3,"Set2") #colors
barfill <- "#4271AE"
barlines <- "#1F3552"

p =ggplot(rhats, aes(Rhat)) +
  geom_histogram(colour = barlines, fill = barfill,binwidth = 0.01)+ #colour = barlines, fill = barfill
  theme_bw() +
  labs(x = "Rhat", y = "Count\n")+
  theme(axis.line = element_line(size=1, colour = "black"),
        panel.grid.major = element_line(colour = "grey",size = 0.1,linetype = "dashed"),
        panel.grid.minor = element_line(colour = "grey",size = 0.1,linetype = "dashed"),
        panel.border = element_blank(),
        panel.background = element_blank(),
        plot.title = element_text(size = 18,  face = "bold",hjust = 0.5),
        text=element_text(colour="black", size = 14),
        axis.text.x=element_text(colour="black", size = 14),
        axis.text.y=element_text(colour="black", size = 14, face = "plain",hjust=0),
        axis.title=element_text(size=18,colour = "black",vjust = 1))

p


# Print the names of the low Rhat parameters
highRhats = subset(rhats,rhats$Rhat>1.1)
highRhats
```



## Trace plots


```{r, message=FALSE}
traces <- read.csv('output/Mixed/ae_only/modelMixed3/modelMixed3_traces.csv')

traces<-traces %>% dplyr::select(a_Intercept,
                                 a_C.intervalType..Sum..S.Speed.,
                                 a_C.blockType..Poly..Linear,
                                 a_C.blockType..Poly..Quadratic,
                                 a_C.blockType..Poly..Cubic,
                                 a_C.intervalType..Sum..S.Speed..C.blockType..Poly..Linear,
                                 a_C.intervalType..Sum..S.Speed..C.blockType..Poly..Quadratic,
                                 a_C.intervalType..Sum..S.Speed..C.blockType..Poly..Cubic,
                                 
                                 v_Intercept,
                                 v_C.intervalType..Sum..S.Speed.,
                                 v_C.congruency..Sum..S.incongruent.,
                                 v_C.blockType..Poly..Linear,
                                 v_C.blockType..Poly..Quadratic,
                                 v_C.blockType..Poly..Cubic,
                                 v_C.intervalType..Sum..S.Speed..C.blockType..Poly..Linear,
                                 v_C.intervalType..Sum..S.Speed..C.blockType..Poly..Quadratic,
                                 v_C.intervalType..Sum..S.Speed..C.blockType..Poly..Cubic,

                                 t)%>%
                          
  mutate(a_Intercept=0.5*a_Intercept,
         a_C.intervalType..Sum..S.Speed.=0.5*a_C.intervalType..Sum..S.Speed.,
         a_C.blockType..Poly..Linear=0.5*a_C.blockType..Poly..Linear,
         a_C.blockType..Poly..Quadratic=0.5*a_C.blockType..Poly..Quadratic,
         a_C.blockType..Poly..Cubic=0.5*a_C.blockType..Poly..Cubic,
         a_C.intervalType..Sum..S.Speed..C.blockType..Poly..Linear=0.5*a_C.intervalType..Sum..S.Speed..C.blockType..Poly..Linear,
         a_C.intervalType..Sum..S.Speed..C.blockType..Poly..Quadratic=0.5*a_C.intervalType..Sum..S.Speed..C.blockType..Poly..Quadratic,
         a_C.intervalType..Sum..S.Speed..C.blockType..Poly..Cubic=0.5*a_C.intervalType..Sum..S.Speed..C.blockType..Poly..Cubic)



# For each parameter
colNames= names(traces)

for (parameter in colNames) {

  #Plotting
  plot_data1 = traces[1:2000,]
  plot_data2 = traces[2001:4000,]
  plot_data3 = traces[4001:6000,]
  plot_data4 = traces[6001:8000,]
  plot_data5 = traces[8001:10000,]



  traces_plot = ggplot(NULL) +

    # Chain 1
    geom_line(data=plot_data1,mapping =aes_string(y=parameter,x = 1:2000), colour="red")+

    # Chain 2
    geom_line(data=plot_data2,mapping =aes_string(y=parameter,x = 1:2000), colour="royalblue1")+

    # Chain 3
    geom_line(data=plot_data3,mapping =aes_string(y=parameter,x = 1:2000), colour="springgreen")+

    # Chain 4
    geom_line(data=plot_data4,mapping =aes_string(y=parameter,x = 1:2000), colour="grey0")+

    # Chain 5
    geom_line(data=plot_data5,mapping =aes_string(y=parameter,x = 1:2000), colour="coral")+
    theme_classic(base_size = 18) +

    ggtitle(parameter)  + ylab("Parameter value") + xlab("Sample")



  print(traces_plot)
}
```




## PPCs


```{r, message=FALSE}

df.ppc <- fread('output/Mixed/ae_only/modelMixed3/modelMixed3_simData.csv') %>%
  mutate(simResponse=rt_sampled>0,
         Response=rt>0,
         rt_unsigned = abs(rt),
         rt_sampled_unsigned = abs(rt_sampled))

df.ppc.sim <- df.ppc %>% filter(sample==0,rt_sampled_unsigned<=3)

df.ppc.data <- df.ppc %>% filter(sample==0,rt_unsigned<=3)

ratio.true <- sum(!df.ppc.data$Response)/sum(df.ppc.data$Response)

ratio.simu <- sum(!df.ppc.sim$simResponse)/sum(df.ppc.sim$simResponse)

# Density plots with means
p = ggplot(df.ppc.data %>% filter(Response),
      aes(x=rt_unsigned,color='Correct',linetype='True')) +
      geom_density(size=1) +
      geom_density(data=df.ppc.data %>% filter(!Response),
               size=1,
               aes(x=rt_unsigned,y=-..density..*ratio.true,color='Incorrect',linetype='True')) +
      geom_density(data=df.ppc.sim %>% filter(simResponse),
               size=1,
               aes(x=rt_sampled_unsigned,color='Correct',linetype='Simulation')) +
      geom_density(data=df.ppc.sim %>% filter(!simResponse),
               size=1,
               aes(x=rt_sampled_unsigned,y=-..density..*ratio.simu,color='Incorrect',linetype='Simulation')) + 
      geom_hline(yintercept=0) + 
      ggdensity +
      xlab('Reaction Time') + 
      ylab('Density') + 
      coord_cartesian(xlim=c(0,2),ylim=c(-0.3,3)) + 
      facet_grid(cols=vars(intervalType),rows=vars(blockType)) +
      scale_linetype_manual(name='Data:',values=c('Simulation'=1,'True'=2)) + 
      scale_color_manual(name='Response:',values=c('Correct'='blue','Incorrect'='red')) + 
      theme(axis.line = element_line(colour = "black"),
          plot.margin=grid::unit(c(5,5,5,5), "mm"),
          axis.title.y = element_text(margin = margin(t = 0, r = 0, b = 0, l = 0),color="black"),
          text = element_text(size=25,color = "black"),
          panel.border = element_rect (colour = "black", fill = F),
          panel.grid.major = element_blank(),
          panel.grid.minor = element_blank(),
          panel.background = element_blank(),
          axis.text.x = element_text(color="black"),
          axis.text.y = element_text(color="black"),
          axis.ticks = element_line(color = "black"),
          legend.position = c(0.8, 0.25),
          legend.background = element_rect(fill = "transparent", color = NA))  

p

FigS1_D = p
```





## Import the posteriors


```{r, message=FALSE}
traces <- read.csv('output/Mixed/ae_only/modelMixed3/modelMixed3_traces.csv')


traces<-traces %>% dplyr::select(a_Intercept,
                                 a_C.intervalType..Sum..S.Speed.,
                                 a_C.blockType..Poly..Linear,
                                 a_C.blockType..Poly..Quadratic,
                                 a_C.blockType..Poly..Cubic,
                                 a_C.intervalType..Sum..S.Speed..C.blockType..Poly..Linear,
                                 a_C.intervalType..Sum..S.Speed..C.blockType..Poly..Quadratic,
                                 a_C.intervalType..Sum..S.Speed..C.blockType..Poly..Cubic,
                                 a_scaledRunningTime,
                                 
                                 v_Intercept,
                                 v_C.intervalType..Sum..S.Speed.,
                                 v_C.congruency..Sum..S.incongruent.,
                                 v_C.blockType..Poly..Linear,
                                 v_C.blockType..Poly..Quadratic,
                                 v_C.blockType..Poly..Cubic,
                                 v_C.intervalType..Sum..S.Speed..C.blockType..Poly..Linear,
                                 v_C.intervalType..Sum..S.Speed..C.blockType..Poly..Quadratic,
                                 v_C.intervalType..Sum..S.Speed..C.blockType..Poly..Cubic,
                                 v_C.congruency..Sum..S.incongruent.,

                                 t,
                                 z_C.congruency..Sum..S.incongruent.,
                                 p_outlier)%>%
                          
  mutate(a_Intercept=0.5*a_Intercept,
         a_C.intervalType..Sum..S.Speed.=0.5*a_C.intervalType..Sum..S.Speed.,
         a_C.blockType..Poly..Linear=0.5*a_C.blockType..Poly..Linear,
         a_C.blockType..Poly..Quadratic=0.5*a_C.blockType..Poly..Quadratic,
         a_C.blockType..Poly..Cubic=0.5*a_C.blockType..Poly..Cubic,
         a_C.intervalType..Sum..S.Speed..C.blockType..Poly..Linear=0.5*a_C.intervalType..Sum..S.Speed..C.blockType..Poly..Linear,
         a_C.intervalType..Sum..S.Speed..C.blockType..Poly..Quadratic=0.5*a_C.intervalType..Sum..S.Speed..C.blockType..Poly..Quadratic,
         a_C.intervalType..Sum..S.Speed..C.blockType..Poly..Cubic=0.5*a_C.intervalType..Sum..S.Speed..C.blockType..Poly..Cubic,
         a_scaledRunningTime = 0.5*a_scaledRunningTime)

```

## Parameter estimates
```{r, message=FALSE}
summary_traces = traces

# Get the correct estimates (relative to sum & poly coding)
summary_traces$a_C.intervalType..Sum..S.Speed. = summary_traces$a_C.intervalType..Sum..S.Speed. * 2
summary_traces$v_C.intervalType..Sum..S.Speed. = summary_traces$v_C.intervalType..Sum..S.Speed. * 2

summary_traces$a_C.intervalType..Sum..S.Speed..C.blockType..Poly..Linear = (summary_traces$a_C.intervalType..Sum..S.Speed..C.blockType..Poly..Linear/0.6708204) * 2
summary_traces$v_C.intervalType..Sum..S.Speed..C.blockType..Poly..Linear = (summary_traces$v_C.intervalType..Sum..S.Speed..C.blockType..Poly..Linear/0.6708204) * 2

output <- test.params(summary_traces)
summary <- test.params(summary_traces)

summary$CI_upper <- round(summary$CI_upper,2)
summary$CI_lower <- round(summary$CI_lower,2)
summary$CI <- paste0(summary$CI_lower,", ",summary$CI_upper)
summary$Mean <- round(summary$Mean,2)
summary$pvalue <- round(summary$pvalue,2)
kable(summary)

```


## Transform the traces
```{r, message=FALSE}
# Transform thresholds main effects
thresholdTransform = traces[,c("a_Intercept",
                               "a_C.blockType..Poly..Linear",
                               "a_C.blockType..Poly..Quadratic",
                               "a_C.blockType..Poly..Cubic")]

thresholdTransform$a_Intercept = rep(mean(thresholdTransform$a_Intercept), length(thresholdTransform$a_Intercept))


contrastMatrix = cbind(c(1,1,1,1),contr.poly(4))

tresholdByCondition = t(as.matrix(contrastMatrix) %*% t(as.matrix(thresholdTransform)))
colnames(tresholdByCondition) = c("a_Main_2intervals", "a_Main_4intervals", "a_Main_8intervals","a_Main_Fixed")
tresholdByCondition = as.data.frame(tresholdByCondition)



# Transform thresholds interactions
thresholdTransform = traces[,c("a_C.intervalType..Sum..S.Speed.",
                               "a_C.intervalType..Sum..S.Speed..C.blockType..Poly..Linear",
                               "a_C.intervalType..Sum..S.Speed..C.blockType..Poly..Quadratic",
                               "a_C.intervalType..Sum..S.Speed..C.blockType..Poly..Cubic")]

contrastMatrix = cbind(c(1,1,1,1),contr.poly(4))

tresholdByConditionInteraction = t(as.matrix(contrastMatrix) %*% t(as.matrix(thresholdTransform)))
colnames(tresholdByConditionInteraction) = c("a_Interaction_2intervals", "a_Interaction_4intervals", "a_Interaction_8intervals","a_Interaction_Fixed")
tresholdByConditionInteraction = as.data.frame(tresholdByConditionInteraction)

# Calculate threshold per condition
thresholdEveryCondition = as.data.frame(matrix(1,length(tresholdByConditionInteraction$a_Interaction_2intervals)))

thresholdEveryCondition$Threshold_2intervals_Speed = tresholdByCondition$a_Main_2intervals + tresholdByConditionInteraction$a_Interaction_2intervals 
thresholdEveryCondition$Threshold_2intervals_Accuracy = tresholdByCondition$a_Main_2intervals - tresholdByConditionInteraction$a_Interaction_2intervals 
thresholdEveryCondition$Threshold_2intervals = thresholdEveryCondition$Threshold_2intervals_Accuracy - thresholdEveryCondition$Threshold_2intervals_Speed

thresholdEveryCondition$Threshold_4intervals_Speed = tresholdByCondition$a_Main_4intervals + tresholdByConditionInteraction$a_Interaction_4intervals 
thresholdEveryCondition$Threshold_4intervals_Accuracy = tresholdByCondition$a_Main_4intervals - tresholdByConditionInteraction$a_Interaction_4intervals
thresholdEveryCondition$Threshold_4intervals = thresholdEveryCondition$Threshold_4intervals_Accuracy - thresholdEveryCondition$Threshold_4intervals_Speed


thresholdEveryCondition$Threshold_8intervals_Speed = tresholdByCondition$a_Main_8intervals + tresholdByConditionInteraction$a_Interaction_8intervals 
thresholdEveryCondition$Threshold_8intervals_Accuracy = tresholdByCondition$a_Main_8intervals - tresholdByConditionInteraction$a_Interaction_8intervals
thresholdEveryCondition$Threshold_8intervals = thresholdEveryCondition$Threshold_8intervals_Accuracy - thresholdEveryCondition$Threshold_8intervals_Speed


thresholdEveryCondition$Threshold_Fixed_Speed = tresholdByCondition$a_Main_Fixed + tresholdByConditionInteraction$a_Interaction_Fixed 
thresholdEveryCondition$Threshold_Fixed_Accuracy = tresholdByCondition$a_Main_Fixed - tresholdByConditionInteraction$a_Interaction_Fixed
thresholdEveryCondition$Threshold_Fixed = thresholdEveryCondition$Threshold_Fixed_Accuracy - thresholdEveryCondition$Threshold_Fixed_Speed


thresholdEveryCondition = thresholdEveryCondition[,-1]


output <- test.params(thresholdEveryCondition)


# Transform drift main effects
driftTransform = traces[,c("v_Intercept",
                               "v_C.blockType..Poly..Linear",
                               "v_C.blockType..Poly..Quadratic",
                               "v_C.blockType..Poly..Cubic")]
driftTransform$v_Intercept = rep(mean(driftTransform$v_Intercept), length(driftTransform$v_Intercept))


contrastMatrix = cbind(c(1,1,1,1),contr.poly(4))

driftByCondition = t(as.matrix(contrastMatrix) %*% t(as.matrix(driftTransform)))
colnames(driftByCondition) = c("v_Main_2intervals", "v_Main_4intervals", "v_Main_8intervals","v_Main_Fixed")
driftByCondition = as.data.frame(driftByCondition)



# Transform drift interactions
driftTransform = traces[,c("v_C.intervalType..Sum..S.Speed.",
                               "v_C.intervalType..Sum..S.Speed..C.blockType..Poly..Linear",
                               "v_C.intervalType..Sum..S.Speed..C.blockType..Poly..Quadratic",
                               "v_C.intervalType..Sum..S.Speed..C.blockType..Poly..Cubic")]

contrastMatrix = cbind(c(1,1,1,1),contr.poly(4))

driftByConditionInteraction = t(as.matrix(contrastMatrix) %*% t(as.matrix(driftTransform)))
colnames(driftByConditionInteraction) = c("v_Interaction_2intervals", "v_Interaction_4intervals", "v_Interaction_8intervals","v_Interaction_Fixed")
driftByConditionInteraction = as.data.frame(driftByConditionInteraction)


# Calculate drift per condition
driftEveryCondition = as.data.frame(matrix(1,length(driftByConditionInteraction$v_Interaction_2intervals)))

driftEveryCondition$Drift_2intervals_Speed = driftByCondition$v_Main_2intervals + driftByConditionInteraction$v_Interaction_2intervals 
driftEveryCondition$Drift_2intervals_Accuracy = driftByCondition$v_Main_2intervals - driftByConditionInteraction$v_Interaction_2intervals 
driftEveryCondition$Drift_2intervals = driftEveryCondition$Drift_2intervals_Accuracy - driftEveryCondition$Drift_2intervals_Speed

driftEveryCondition$Drift_4intervals_Speed = driftByCondition$v_Main_4intervals + driftByConditionInteraction$v_Interaction_4intervals 
driftEveryCondition$Drift_4intervals_Accuracy = driftByCondition$v_Main_4intervals - driftByConditionInteraction$v_Interaction_4intervals
driftEveryCondition$Drift_4intervals = driftEveryCondition$Drift_4intervals_Accuracy - driftEveryCondition$Drift_4intervals_Speed


driftEveryCondition$Drift_8intervals_Speed = driftByCondition$v_Main_8intervals + driftByConditionInteraction$v_Interaction_8intervals 
driftEveryCondition$Drift_8intervals_Accuracy = driftByCondition$v_Main_8intervals - driftByConditionInteraction$v_Interaction_8intervals
driftEveryCondition$Drift_8intervals = driftEveryCondition$Drift_8intervals_Accuracy - driftEveryCondition$Drift_8intervals_Speed


driftEveryCondition$Drift_Fixed_Speed = driftByCondition$v_Main_Fixed + driftByConditionInteraction$v_Interaction_Fixed 
driftEveryCondition$Drift_Fixed_Accuracy = driftByCondition$v_Main_Fixed - driftByConditionInteraction$v_Interaction_Fixed
driftEveryCondition$Drift_Fixed = driftEveryCondition$Drift_Fixed_Accuracy - driftEveryCondition$Drift_Fixed_Speed


driftEveryCondition = driftEveryCondition[,-1]

output <- test.params(driftEveryCondition)

                                 
### Summaries

summary = cbind(driftByCondition,driftByConditionInteraction,tresholdByCondition,tresholdByConditionInteraction)

output <- test.params(summary)

va <- output %>% separate(parameter,c('parameter','effect','block'),'_')

labels <- c('Threshold','Drift')

va$effect = as.factor(va$effect)

va$block = as.factor(va$block)

va$parameter<-factor(va$parameter,labels=c('Threshold','Drift Rate'))


```


## Drift rate and threshold


### Bar plot

```{r, message=FALSE}


output1 <- test.params(driftEveryCondition)
output2 = test.params(thresholdEveryCondition)

output = rbind(output1,output2)

output = output[c(3,6,9,12,15,18,21,24),]
                                 
va <- output %>% separate(parameter,c('parameter','block'),'_')

# Change the labels

va$block = factor(va$block, labels = c("Switch 2","Switch 4","Switch 8","Fixed"))
va$block = as.factor(va$block)
va$block = ordered(va$block, levels = c("Fixed","Switch 8","Switch 4","Switch 2"))

va$parameter<-factor(va$parameter,levels = c("Drift","Threshold"))





Color1 = rgb(0.35, 0.35, 0.35)
Color2 = rgb(0.5, 0.5, 0.5)
Color3 = rgb(0.7, 0.7, 0.7)
Color4 = rgb(0.8, 0.8, 0.8)

va$plotting = c(4,3,2,1,4,3,2,1)

# Plot
p<-ggplot(va,aes(x=plotting, y=Mean,fill=block)) +
  geom_bar(width=1,stat="identity", position=position_dodge(0.6)) +
  geom_errorbar(width=.1, size=1.1, position=position_dodge(width = .6),aes(ymin=CI_lower,ymax=CI_upper)) + ylab('Estimate') +
  facet_wrap(vars(parameter), labeller = as_labeller(c('Drift'="Drift rate",'Threshold'="Threshold")))+
  ylim(-0.05,0.5)+
  geom_hline(yintercept=0) +
  scale_fill_viridis(discrete = TRUE ,option = "plasma",end=0.7)+
  scale_x_discrete(expand = c(0.3,0.3))+
  theme(axis.line = element_line(colour = "black"),plot.margin=grid::unit(c(5,5,5,5), "mm"),
        axis.title.y = element_text(margin = margin(t = 0, r = 0, b = 0, l = 0)),
        text = element_text(size=33),
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        panel.border = element_blank(),
        panel.background = element_blank(),
        axis.title.x=element_blank(),
        axis.text.x = element_text(color="black"),
        axis.text.y = element_text(color="black"),
        axis.ticks = element_line(color = "black"),
        legend.position = c(0.78, 0.90),
        legend.background = element_rect(fill = "transparent", color = NA))  
        
p





```

### Points in 2D 

```{r, message=FALSE}


drift.rate<- test.params(driftEveryCondition)[-c(3,6,9,12),]

threshold<- test.params(thresholdEveryCondition)[-c(3,6,9,12),]


va <- rbind(drift.rate,threshold) %>% separate(parameter,c('parameter','fixed','factor'),'_')

va$factor = as.factor(va$factor)

# va$parameter<-factor(va$parameter,labels=c('Threshold','Drift Rate'))


# data = subset(va,fixed=="Varying")
# data = subset(va,isi=="ISI250")

data = va

# data$parameter = c("Drift","Drift","Drift","Drift","Threshold","Threshold","Threshold","Threshold")

# Long to wide
data = pivot_wider(data = data, 
            id_cols = c(factor,fixed), 
            names_from = parameter, 
            values_from = c("Mean","CI_lower","CI_upper"))

# data$factor = c("Speed", "Accuracy","Speed", "Accuracy")

data$factor = factor(data$factor, levels = c("Speed", "Accuracy"))
levels(data$factor) = c("Speed", "Accuracy")

data$fixed = factor(data$fixed, levels = c("Fixed","8intervals","4intervals","2intervals"))

# data$factor = c("Speed", "Accuracy","Speed & Accuracy" )

p<-ggplot(data,aes(x=Mean_Drift, y=Mean_Threshold,color=factor)) +
  geom_point(size=5) +
  geom_errorbar(width=0, size=1.1, position=position_dodge(width = .6),aes(xmin=CI_lower_Drift,xmax=CI_upper_Drift)) +
  geom_errorbar(width=0, size=1.1, position=position_dodge(width = .6),aes(ymin=CI_lower_Threshold,ymax=CI_upper_Threshold))+
  scale_color_viridis(discrete = TRUE ,option = "plasma",end=0.7)+
  facet_wrap(~fixed,nrow=1) +
  ylab("Threshold") + 
  xlab("Drift Rate") + 
  scale_x_continuous(limits = c(2.7,4))+
  scale_y_continuous(limits = c(0.6,1.2))+
  theme(axis.line = element_line(colour = "black"),
        plot.margin=grid::unit(c(5,5,5,5), "mm"),
        axis.title.y = element_text(margin = margin(t = 0, r = 0, b = 0, l = 0),color="black"),
        text = element_text(size=33,color = "black"),
        panel.border = element_rect (colour = "black", fill = F),
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        panel.background = element_blank(),
        axis.text.x = element_text(color="black"),
        axis.text.y = element_text(color="black"),
        axis.ticks = element_line(color = "black"),
        legend.position = "none")  

p

Fig5.DDM = p

```


## Stats

### Mini meta-analysis


```{r, message=FALSE}

# Drift - A-S fixed
Diff_Fix = driftEveryCondition$Drift_Fixed_Accuracy - driftEveryCondition$Drift_Fixed_Speed 
Diff_Fix = as.data.frame(Diff_Fix)
h = (hypothesis(Diff_Fix,"Diff_Fix<0"))
kable(as.data.frame(h$hypothesis),caption="Accuracy vs. Speed Fixed Drift")

# Drift - A-S 8 intervals
Diff_8 = driftEveryCondition$Drift_8intervals_Accuracy - driftEveryCondition$Drift_8intervals_Speed 
Diff_8 = as.data.frame(Diff_8)
h = (hypothesis(Diff_8,"Diff_8<0"))
kable(as.data.frame(h$hypothesis),caption="Accuracy vs. Speed 8 intervals Drift")

# Drift - A-S 4 intervals
Diff_4 = driftEveryCondition$Drift_4intervals_Accuracy - driftEveryCondition$Drift_4intervals_Speed 
Diff_4 = as.data.frame(Diff_4)
h = (hypothesis(Diff_4,"Diff_4<0"))
kable(as.data.frame(h$hypothesis),caption="Accuracy vs. Speed 4 intervals Drift")

# Drift - A-S 2 intervals
Diff_2 = driftEveryCondition$Drift_2intervals_Accuracy - driftEveryCondition$Drift_2intervals_Speed 
Diff_2 = as.data.frame(Diff_2)
h = (hypothesis(Diff_2,"Diff_2<0"))
kable(as.data.frame(h$hypothesis),caption="Accuracy vs. Speed 2 intervals Drift")

# Drift - Cost Fix vs. 8
Diff = Diff_Fix - Diff_8
colnames(Diff) = "Diff"
h = (hypothesis(Diff,"Diff<0"))
kable(as.data.frame(h$hypothesis),caption="Accuracy vs. Speed X Fix vs. 8 Cost")

# Drift - Cost Fix vs. 4
Diff = Diff_Fix - Diff_4
colnames(Diff) = "Diff"
h = (hypothesis(Diff,"Diff<0"))
kable(as.data.frame(h$hypothesis),caption="Accuracy vs. Speed X Fix vs. 4 Cost")

# Drift - Cost Fix vs. 2
Diff = Diff_Fix - Diff_2
colnames(Diff) = "Diff"
h = (hypothesis(Diff,"Diff<0"))
kable(as.data.frame(h$hypothesis),caption="Accuracy vs. Speed X Fix vs. 2 Cost")


# Threshold - A-S fixed
Diff_Fix = thresholdEveryCondition$Threshold_Fixed_Accuracy - thresholdEveryCondition$Threshold_Fixed_Speed 
Diff_Fix = as.data.frame(Diff_Fix)
h = (hypothesis(Diff_Fix,"Diff_Fix<0"))
kable(as.data.frame(h$hypothesis),caption="Accuracy vs. Speed Fixed Threshold")

# Threshold - A-S 8 intervals
Diff_8 = thresholdEveryCondition$Threshold_8intervals_Accuracy - thresholdEveryCondition$Threshold_8intervals_Speed 
Diff_8 = as.data.frame(Diff_8)
h = (hypothesis(Diff_8,"Diff_8<0"))
kable(as.data.frame(h$hypothesis),caption="Accuracy vs. Speed 8 intervals Threshold")

# Threshold - A-S 4 intervals
Diff_4 = thresholdEveryCondition$Threshold_4intervals_Accuracy - thresholdEveryCondition$Threshold_4intervals_Speed 
Diff_4 = as.data.frame(Diff_4)
h = (hypothesis(Diff_4,"Diff_4<0"))
kable(as.data.frame(h$hypothesis),caption="Accuracy vs. Speed 4 intervals Threshold")

# Threshold - A-S 2 intervals
Diff_2 = thresholdEveryCondition$Threshold_2intervals_Accuracy - thresholdEveryCondition$Threshold_2intervals_Speed 
Diff_2 = as.data.frame(Diff_2)
h = (hypothesis(Diff_2,"Diff_2<0"))
kable(as.data.frame(h$hypothesis),caption="Accuracy vs. Speed 2 intervals Threshold")

# Threshold - Cost Fix vs. 8
Diff = Diff_Fix - Diff_8
colnames(Diff) = "Diff"
h = (hypothesis(Diff,"Diff<0"))
kable(as.data.frame(h$hypothesis),caption="Accuracy vs. Speed X Fix vs. 8 Cost")

# Threshold - Cost Fix vs. 4
Diff = Diff_Fix - Diff_4
colnames(Diff) = "Diff"
h = (hypothesis(Diff,"Diff<0"))
kable(as.data.frame(h$hypothesis),caption="Accuracy vs. Speed X Fix vs. 4 Cost")

# Threshold - Cost Fix vs. 2
Diff = Diff_Fix - Diff_2
colnames(Diff) = "Diff"
h = (hypothesis(Diff,"Diff<0"))
kable(as.data.frame(h$hypothesis),caption="Accuracy vs. Speed X Fix vs. 2 Cost")


# Distance

Distance_Fixed = sqrt((driftEveryCondition$Drift_Fixed_Accuracy - driftEveryCondition$Drift_Fixed_Speed)**2 + (thresholdEveryCondition$Threshold_Fixed_Accuracy - thresholdEveryCondition$Threshold_Fixed_Speed)**2)
kable(test.params(as.data.frame(Distance_Fixed)))

Distance_2 = sqrt((driftEveryCondition$Drift_2intervals_Accuracy - driftEveryCondition$Drift_2intervals_Speed)**2 + (thresholdEveryCondition$Threshold_2intervals_Accuracy - thresholdEveryCondition$Threshold_2intervals_Speed)**2)
kable(test.params(as.data.frame(Distance_Fixed-Distance_2)))

Distance_4 = sqrt((driftEveryCondition$Drift_4intervals_Accuracy - driftEveryCondition$Drift_4intervals_Speed)**2 + (thresholdEveryCondition$Threshold_4intervals_Accuracy - thresholdEveryCondition$Threshold_4intervals_Speed)**2)
kable(test.params(as.data.frame(Distance_Fixed-Distance_4)))

Distance_8 = sqrt((driftEveryCondition$Drift_8intervals_Accuracy - driftEveryCondition$Drift_8intervals_Speed)**2 + (thresholdEveryCondition$Threshold_8intervals_Accuracy - thresholdEveryCondition$Threshold_8intervals_Speed)**2)
kable(test.params(as.data.frame(Distance_Fixed-Distance_8)))

# Normalized distance

# Threshold & Drift overall min & max
a_max = max(rbind(thresholdEveryCondition$Threshold_Fixed_Accuracy,
                  thresholdEveryCondition$Threshold_2intervals_Accuracy,
                  thresholdEveryCondition$Threshold_4intervals_Accuracy,
                  thresholdEveryCondition$Threshold_8intervals_Accuracy,
                  thresholdEveryCondition$Threshold_Fixed_Speed,
                  thresholdEveryCondition$Threshold_2intervals_Speed,
                  thresholdEveryCondition$Threshold_4intervals_Speed,
                  thresholdEveryCondition$Threshold_8intervals_Speed))

a_min = min(rbind(thresholdEveryCondition$Threshold_Fixed_Accuracy,
                  thresholdEveryCondition$Threshold_2intervals_Accuracy,
                  thresholdEveryCondition$Threshold_4intervals_Accuracy,
                  thresholdEveryCondition$Threshold_8intervals_Accuracy,
                  thresholdEveryCondition$Threshold_Fixed_Speed,
                  thresholdEveryCondition$Threshold_2intervals_Speed,
                  thresholdEveryCondition$Threshold_4intervals_Speed,
                  thresholdEveryCondition$Threshold_8intervals_Speed))

v_max = max(rbind(driftEveryCondition$Drift_Fixed_Accuracy,
                  driftEveryCondition$Drift_2intervals_Accuracy,
                  driftEveryCondition$Drift_4intervals_Accuracy,
                  driftEveryCondition$Drift_8intervals_Accuracy,
                  driftEveryCondition$Drift_Fixed_Speed,
                  driftEveryCondition$Drift_2intervals_Speed,
                  driftEveryCondition$Drift_4intervals_Speed,
                  driftEveryCondition$Drift_8intervals_Speed))

v_min = min(rbind(driftEveryCondition$Drift_Fixed_Accuracy,
                  driftEveryCondition$Drift_2intervals_Accuracy,
                  driftEveryCondition$Drift_4intervals_Accuracy,
                  driftEveryCondition$Drift_8intervals_Accuracy,
                  driftEveryCondition$Drift_Fixed_Speed,
                  driftEveryCondition$Drift_2intervals_Speed,
                  driftEveryCondition$Drift_4intervals_Speed,
                  driftEveryCondition$Drift_8intervals_Speed))

# Normalization
v_rangeNorm <- function(x){
  (x-v_min)/(v_max-v_min)
}
a_rangeNorm <- function(x){
  (x-a_min)/(a_max-a_min)
}

Distance_Fixed = sqrt((v_rangeNorm(driftEveryCondition$Drift_Fixed_Accuracy) - v_rangeNorm(driftEveryCondition$Drift_Fixed_Speed))**2 + (a_rangeNorm(thresholdEveryCondition$Threshold_Fixed_Accuracy) - a_rangeNorm(thresholdEveryCondition$Threshold_Fixed_Speed))**2)
kable(test.params(as.data.frame(Distance_Fixed)))

Distance_2 = sqrt((v_rangeNorm(driftEveryCondition$Drift_2intervals_Accuracy) - v_rangeNorm(driftEveryCondition$Drift_2intervals_Speed))**2 + (a_rangeNorm(thresholdEveryCondition$Threshold_2intervals_Accuracy) - a_rangeNorm(thresholdEveryCondition$Threshold_2intervals_Speed))**2)
kable(test.params(as.data.frame(Distance_Fixed-Distance_2)))

Distance_4 = sqrt((v_rangeNorm(driftEveryCondition$Drift_4intervals_Accuracy) - v_rangeNorm(driftEveryCondition$Drift_4intervals_Speed))**2 + (a_rangeNorm(thresholdEveryCondition$Threshold_4intervals_Accuracy) - a_rangeNorm(thresholdEveryCondition$Threshold_4intervals_Speed))**2)
kable(test.params(as.data.frame(Distance_Fixed-Distance_4)))

Distance_8 = sqrt((v_rangeNorm(driftEveryCondition$Drift_8intervals_Accuracy) - v_rangeNorm(driftEveryCondition$Drift_8intervals_Speed))**2 + (a_rangeNorm(thresholdEveryCondition$Threshold_8intervals_Accuracy) - a_rangeNorm(thresholdEveryCondition$Threshold_8intervals_Speed))**2)
kable(test.params(as.data.frame(Distance_Fixed-Distance_8)))


```

### Drift rate (2-way interaction)


```{r, message=FALSE}


Interaction = summary_traces$v_C.intervalType..Sum..S.Speed..C.blockType..Poly..Linear 

Interaction = as.data.frame(Interaction)
h = (hypothesis(Interaction,"Interaction<0"))
kable(as.data.frame(h$hypothesis),caption="Interaction Drift")


# Plot
p = ggplot(data=Interaction,aes(x=Interaction)) + 
  geom_histogram(bins = 30,fill="transparent",color="black") + 
  geom_vline(xintercept=0,linetype="dashed",size=1.3) +
  xlab("Drift rate") + 
  ylab("Frequency") + 
  ggtitle("S/A x block") + 
  # scale_x_continuous(limits = c(-0.7,0.7))+
  # scale_y_continuous(limits = c(0,2600),expand = c(0,0))+
  theme(axis.line = element_line(colour = "black"),plot.margin=grid::unit(c(5,5,5,5), "mm"),
        axis.title.y = element_text(margin = margin(t = 0, r = 0, b = 0, l = 0),color="black"),
        text = element_text(size=33),
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        panel.border = element_blank(),
        panel.background = element_blank(),
        axis.text.x = element_text(color="black"),
        axis.text.y = element_text(color="black"),
        axis.ticks = element_line(color = "black"),
        legend.position = c(0.30, 0.85),
        legend.background = element_rect(fill = "transparent", color = NA)) 

p


Fig5.DDM_Diff_V = p


```


### Threshold (2-way interaction)


```{r, message=FALSE}


Interaction = summary_traces$a_C.intervalType..Sum..S.Speed..C.blockType..Poly..Linear 

Interaction = as.data.frame(Interaction)
h = (hypothesis(Interaction,"Interaction<0"))
kable(as.data.frame(h$hypothesis),caption="Interaction Threshold")


# Plot
p = ggplot(data=Interaction,aes(x=Interaction)) + 
  geom_histogram(bins = 30,fill="transparent",color="black") + 
  geom_vline(xintercept=0,linetype="dashed",size=1.3) +
  xlab("Threshold") + 
  ylab("Frequency") + 
  ggtitle("S/A x block") + 
  # scale_x_continuous(limits = c(-0.7,0.7))+
  # scale_y_continuous(limits = c(0,2600),expand = c(0,0))+
  theme(axis.line = element_line(colour = "black"),plot.margin=grid::unit(c(5,5,5,5), "mm"),
        axis.title.y = element_text(margin = margin(t = 0, r = 0, b = 0, l = 0),color="black"),
        text = element_text(size=33),
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        panel.border = element_blank(),
        panel.background = element_blank(),
        axis.text.x = element_text(color="black"),
        axis.text.y = element_text(color="black"),
        axis.ticks = element_line(color = "black"),
        legend.position = c(0.30, 0.85),
        legend.background = element_rect(fill = "transparent", color = NA)) 

p


Fig5.DDM_Diff_A = p


```


## Results summary


```{r, message=FALSE}

# # Drift rate interaction
# post = as.data.frame(driftTransform)
# post = post["v_C.intervalType..Sum..S.Speed..C.blockType..Poly..Linear"]
#    
# ggplot(data=post,aes(x=post$`v_C.intervalType..Sum..S.Speed..C.blockType..Poly..Linear`)) + 
#      geom_histogram(bins=50) + 
#      geom_vline(xintercept=0, linetype="dotted",size=1) +
#      labs(title=paste("Acc-Speed","p<0 = ",length(post[post<0])/length(post$`v_C.intervalType..Sum..S.Speed..C.blockType..Poly..Linear`))) +
#      theme_classic() 
# 
# 
# # Threshold interaction
# post = as.data.frame(thresholdTransform)
# post = post["a_C.intervalType..Sum..S.Speed..C.blockType..Poly..Linear"]
#    ggplot(data=post,aes(x=post$`a_C.intervalType..Sum..S.Speed..C.blockType..Poly..Linear`)) + 
#      geom_histogram(bins=50) + 
#      geom_vline(xintercept=0, linetype="dotted",size=1) +
#      labs(title=paste("Acc-Speed","p<0 = ",length(post[post<0])/length(post$`a_C.intervalType..Sum..S.Speed..C.blockType..Poly..Linear`))) +
#      theme_classic() 






```




# Simulations

## Fixed gain model

### Import the data


```{r, message=FALSE}
# Import, tidy, and merge the simulations data
sim_data_fixed = read.csv("../model_simulations/Experiment5_fixed_g_fixed_5.csv")
sim_data_fixed$fixed = c("Fixed","Fixed")

sim_data_8 = read.csv("../model_simulations/Experiment5_8_g_fixed_5.csv")
sim_data_8$fixed = c("8intervals","8intervals")

sim_data_4 = read.csv("../model_simulations/Experiment5_4_g_fixed_5.csv")
sim_data_4$fixed = c("4intervals","4intervals")

sim_data_2 = read.csv("../model_simulations/Experiment5_2_g_fixed_5.csv")
sim_data_2$fixed = c("2intervals","2intervals")

sim_data = rbind(sim_data_fixed,sim_data_8,sim_data_4,sim_data_2)


# Change condition names
sim_data$condition = ifelse(sim_data$condition==0,"Speed","Accuracy")

# Change variable names
colnames(sim_data) = c("factor","Mean_Drift","Mean_Threshold","v_star","a_star","fixed")

# Order the factor
sim_data$factor = factor(sim_data$factor,levels = c("Speed", "Accuracy"))
sim_data$fixed = factor(sim_data$fixed, levels = c("Fixed","8intervals","4intervals","2intervals"))


```

### Summary table

```{r, message=FALSE}


kable(sim_data)

```

### Plot


```{r, message=FALSE}

p<-ggplot(sim_data,aes(x=Mean_Drift, y=Mean_Threshold,color=factor)) +
  geom_point(size=5) +
  scale_color_viridis(discrete = TRUE ,option = "plasma",end=0.7)+
  facet_wrap(~fixed,nrow=1) +
  ylab("Threshold") + 
  xlab("Drift Rate") + 
  scale_x_continuous(limits = c(2.7,4))+
  scale_y_continuous(limits = c(0.6,1.2))+
  theme(axis.line = element_line(colour = "black"),
        plot.margin=grid::unit(c(5,5,5,5), "mm"),
        axis.title.y = element_text(margin = margin(t = 0, r = 0, b = 0, l = 0),color="black"),
        text = element_text(size=33,color = "black"),
        panel.border = element_rect (colour = "black", fill = F),
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        panel.background = element_blank(),
        axis.text.x = element_text(color="black"),
        axis.text.y = element_text(color="black"),
        axis.ticks = element_line(color = "black"),
        legend.position = "none")  

p



Fig5.DDM_sim_fixed_gain = p

```




## Varying gain model

### Import the data


```{r, message=FALSE}
# Import, tidy, and merge the simulations data
sim_data_fixed = read.csv("../model_simulations/Experiment4_fixed_g_varying_5.csv")
sim_data_fixed$fixed = c("Fixed","Fixed")

sim_data_8 = read.csv("../model_simulations/Experiment4_8_g_varying_3.csv")
sim_data_8$fixed = c("8intervals","8intervals")

sim_data_4 = read.csv("../model_simulations/Experiment4_4_g_varying_2.5.csv")
sim_data_4$fixed = c("4intervals","4intervals")

sim_data_2 = read.csv("../model_simulations/Experiment4_2_g_varying_2.csv")
sim_data_2$fixed = c("2intervals","2intervals")

sim_data = rbind(sim_data_fixed,sim_data_8,sim_data_4,sim_data_2)


# Change condition names
sim_data$condition = ifelse(sim_data$condition==0,"Speed","Accuracy")

# Change variable names
colnames(sim_data) = c("factor","Mean_Drift","Mean_Threshold","v_star","a_star","fixed")

# Order the factor
sim_data$factor = factor(sim_data$factor,levels = c("Speed", "Accuracy"))
sim_data$fixed = factor(sim_data$fixed, levels = c("Fixed","8intervals","4intervals","2intervals"))


```

### Summary table

```{r, message=FALSE}


kable(sim_data)

```

### Plot


```{r, message=FALSE}

p<-ggplot(sim_data,aes(x=Mean_Drift, y=Mean_Threshold,color=factor)) +
  geom_point(size=5) +
  scale_color_viridis(discrete = TRUE ,option = "plasma",end=0.7)+
  facet_wrap(~fixed,nrow=1) +
  ylab("Threshold") + 
  xlab("Drift Rate") + 
  scale_x_continuous(limits = c(2.7,4))+
  scale_y_continuous(limits = c(0.6,1.2))+
  theme(axis.line = element_line(colour = "black"),
        plot.margin=grid::unit(c(5,5,5,5), "mm"),
        axis.title.y = element_text(margin = margin(t = 0, r = 0, b = 0, l = 0),color="black"),
        text = element_text(size=33,color = "black"),
        panel.border = element_rect (colour = "black", fill = F),
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        panel.background = element_blank(),
        axis.text.x = element_text(color="black"),
        axis.text.y = element_text(color="black"),
        axis.ticks = element_line(color = "black"),
        legend.position = "none")  

p



Fig5.DDM_sim_varying_gain = p

```




# Save the figures


```{r, message=FALSE}

# Save the figure
pdf(file="../../../Manuscript/figures/Figure_5_DDM&Sim.pdf",height=14,width=13.5)

p = cowplot::plot_grid(Fig5.DDM,
                       Fig5.DDM_sim_fixed_gain,
                       Fig5.DDM_sim_varying_gain,
                       nrow = 3)
p
dev.off()


# Save the figure
pdf(file="../../../Manuscript/figures/Figure_S1_D.pdf",height=20,width=10)

p = cowplot::plot_grid(FigS1_D,
                       nrow = 1,
                       ncol = 1)
p
dev.off()





```

